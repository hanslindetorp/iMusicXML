!function($){var defaultSectionName="default",SECTION="sc",TRACK="tr",MOTIF="mt",LEADIN="ld",SOUND="sn",POSITION="p",VARIANT="v",UPBEAT="up",QUANTIZE="q",LENGTH="l",audioContext,maxChannelCount;function initGUI(t){t||(t=$(body));var e=1;iMus.instances.forEach(function(a){var i=[],r=[];a.sections.forEach(function(t){t.tags.forEach(function(t){!inArray(t,i)&&t.length&&i.push(t)}),t.idName.split(" ").forEach(function(t){!inArray(t,r)&&t.length&&r.push(t)}),t.tracks.forEach(function(t){t.tags.forEach(function(t){!inArray(t,i)&&t.length&&i.push(t)}),t.idName.split(" ").forEach(function(t){!inArray(t,r)&&t.length&&r.push(t)})})}),a.motifs.forEach(function(t){t.tags.forEach(function(t){!inArray(t,i)&&t.length&&i.push(t)}),t.idName.split(" ").forEach(function(t){!inArray(t,r)&&t.length&&r.push(t)})});var n=$("<h2>").html("Music "+e),s=$("<div>",{class:"mixerInstance",id:"mixerInstance-"+e}).append(n),o=$("<div>",{class:"mixerGroups"}),u=$("<div>",{class:"mixerSingles"});s.append(o,u),t.append(s),i.forEach(function(t){var e=new ChannelStrip(a,".",t);o.append(e)}),r.forEach(function(t){var e=new ChannelStrip(a,"#",t);u.append(e)});var l=u.offset().top+u.innerHeight();t.innerHeight(l),e++})}function ChannelStrip(t,e,a){if($label=$("<span>",{class:"label"}).html(e+a),$gui=$("<div>",{class:"channelstrip"}),$slider=$("<div>"),$slider.append($label),$playBtn=$("<button>",{class:"playBtn"}).css({backgroundColor:"white"}).html(">"),$gui.append($slider,$playBtn),$.ui){var i=t.find(e+a).getVolume();i=-1==i?1:i,i=Math.floor(100*i)/100,$slider.slider({value:100*i,min:0,max:200,orientation:"vertical",slide:function(i,r){var n=r.value/100;$(this).find(".ui-slider-handle").html(n),$(this).data("changed",!0),t.find(e+a).setVolume(n)},change:function(t,e){}}).data("selector",e+a).dblclick(function(){$(this).slider("value",100),$(this).find(".ui-slider-handle").html(1),t.find(e+a).setVolume(1)}).find(".ui-slider-handle").html(i)}return $playBtn.click(function(){var i=!$(this).data("state");$(this).data("state",i);var r=i?"green":"white";$(this).css({backgroundColor:r});var n=t.find(e+a);i?n.play():n.stop()}),$gui}function getTimeSign(ts,defTimeSign){if("off"==ts)return ts;var timeSign={};if("string"==typeof ts)switch(ts){case"bar":return{nominator:defTimeSign.nominator,denominator:defTimeSign.denominator};case"beat":return{nominator:1,denominator:defTimeSign.denominator};default:return tsArr=ts.split("/"),tsArr.length<2&&(tsArr[1]=1),{nominator:eval(tsArr[0]),denominator:eval(tsArr[1])}}return"object"==typeof ts&&ts.nominator&&ts.denominator?ts:{nominator:4,denominator:4}}function stringIsTimeSign(t){return 2==t.split("/").length}function divisionToTime(t,e,a){return t?(e=e||this.parameters.timeSign,a=a||this.getBeatDuration(),(t=getTimeSign(t,e)).nominator*a*e.nominator/t.denominator):0}function getMaxUpbeatOffset(t){t=t||this.tracks;var e=0;for(var a in t){var i=t[a];if(i.parts.length){var r=i.parts[0];e=Math.min(e,r.offset)}}return-e}function getMaxFadeTime(t){t=t||this.tracks;var e=0;return t.forEach(function(t){e=Math.max(e,t.parameters.fadeTime)}),e}function arrayWithValue(t,e){for(var a=[],i=0;i<t;i++)a[i]=e;return a}function createGainNode(){return void 0===audioContext.createGain?audioContext.createGainNode():audioContext.createGain()}function initAudioContextTimer(t){if(0==audioContext.currentTime){var e=audioContext.createOscillator();void 0===e.start?e.noteOn(0):e.start(0)}}function addLFO(t,e,a,i,r){if("string"==typeof t){var n;if(void 0===r){if(this instanceof Section||this instanceof Track||this instanceof Motif||this instanceof Sequence?n=this.bus:this instanceof Bus&&(n=this),n)switch(t){case"filter":r=n.filter.detune;break;case"volume":r=n.output.gain}}else r=r;if("object"==typeof r){e=e||1,a=a||1,i=i||0;var s=audioContext.createOscillator(),o=createGain();o.gain.value=a,s.frequency.value=e,s.connect(o),o.connect(r),s.start()}}}if($&&($.fn.iMusGUI=function(){return this.each(function(){initGUI($(this))})}),window.AudioContext=window.AudioContext||window.webkitAudioContext,AudioContext){audioContext=new AudioContext,maxChannelCount=audioContext.destination.maxChannelCount||2,console.log("Max audio channels: "+maxChannelCount),audioContext.destination.maxChannelCount?audioContext.destination.channelCount=maxChannelCount:audioContext.destination.webkitMaxChannelCount&&(audioContext.destination.webkitChannelCount=maxChannelCount);var channelCount=audioContext.destination.channelCount||audioContext.destination.webkitChannelCount;console.log("Number of channels: "+channelCount);var buffers={},timeWindow=.1,checkQueueTime=20,Bus=function(t){t=t||{},this.parameters=this.initParameters(t),this.splitter=audioContext.createChannelSplitter();var e=t.destination||audioContext.destination;return this.output=createGainNode(),this.output.gain.value="number"==typeof t.volume?t.volume:1,this.output.connect(e),this.compressor=audioContext.createDynamicsCompressor(),this.compressor.connect(this.output),this.compressor.ratio.value=1,this.panner=audioContext.createPanner(),this.panner.setPosition(0,0,0),this.panner.connect(this.output),this.filter=audioContext.createBiquadFilter(),this.filter.frequency.value=2e4,this.filter.connect(this.output),this.inserts=[],this.inserts.push(this.filter),this.input=createGainNode(),this.input.connect(this.filter),this.sends={},this.channelMerger=t.channelMerger||self.channelMerger,this};Bus.prototype.initParameters=initParameters,Bus.prototype.addDefaultParameters=addDefaultParameters,Bus.prototype.getBeatDuration=getBeatDuration,Bus.prototype.getBarDuration=getBarDuration,Bus.prototype.getTime=getTime,Bus.prototype.setOutput=function(t,e){if(this.output.disconnect(0),this.splitter.disconnect(0),this.output.connect(this.splitter,0,0),this.outputGainList=[],"number"==typeof t&&(t=[t]),e)"number"==typeof e&&(e=[e]);else{e=t,t=[];for(var a=0;a<this.output.channelCount;a++)t.push(a)}var i=Math.max(t.length,e.length);for(a=0;a<i;a++){var r=t[a%t.length];r=Math.min(r,maxChannelCount-1);var n=e[a%e.length];n=Math.min(n,maxChannelCount-1);var s=createGainNode();this.outputGainList[n]=s,this.splitter.connect(s,r,0),s.connect(this.channelMerger,0,n)}},Bus.prototype.volume=function(t){if(void 0===t)return this.input.gain.value;this.input.gain.linearRampToValueAtTime(t,audioContext.currentTime+.001)},Bus.prototype.setVolume=Bus.prototype.volume,Bus.prototype.compression=function(t){if(void 0===t)return this.compressor;if(0==t);else for(var e in t)this.compressor[e].value=t[e]},Bus.prototype.animate=function(t,e,a){switch(a=a||0,t){case"pan":this.outputGainList||this.channelMerger&&this.setOutput([0,1],[0,1]);for(var i=e-this.parameters.pan,r=this.outputGainList.length,n=Math.max(2,10*a),s=0;s<=n;s++){var o=(r-1)*(this.parameters.pan+i*s/n),u=Math.floor(o),l=o%1,c=audioContext.currentTime+a*s/n;this.outputGainList.forEach(function(t,e){var a;switch(e){case u:a=1-l;break;case u+1:a=l;break;default:a=0}t.gain.linearRampToValueAtTime(a,c)})}this.parameters.pan=e;break;default:var f=this.sends[t];if(!f)return;c=audioContext.currentTime+a;f.gain.linearRampToValueAtTime(e,a)}},Bus.prototype.setFilter=function(t){var e=audioContext.currentTime+.01;this.filter.frequency.linearRampToValueAtTime(t,e)},Bus.prototype.addPingPongDelay=function(t){var e,a=(t=t||{}).feedBack||10;e="string"==typeof t.delay?this.getTime(t.delay):t.delay?t.delay/1e3:.25;var i,r,n=t.outputs||[0,1],s=t.volume||.5;this.pingPongDelay=createGainNode(),this.output.connect(this.pingPongDelay,0,0);for(var o=1;o<=a;o++){i=audioContext.createDelay(a*e),this.pingPongDelay.connect(i,0),i.delayTime.value=e*o,(r=createGainNode()).gain.value=s,s*=.5,r.channelCount=1,r.channelCountMode="explicit",r.channelInterpretation="discrete",i.connect(r,0,0);var u=Math.floor(Math.random()*n.length-1),l=n.splice(u,1)[0];n.push(l),r.connect(this.channelMerger,0,l)}},Bus.prototype.addSerialDelay=function(t){var e=(t=t||{}).feedBack||10;if(Array.isArray(t.delayTimes)&&t.delayTimes.length&&(this.delayTimes=t.delayTimes),this.delayTaps=[],"string"==typeof t.delay)u=this.getTime(t.delay);else if("number"==typeof t.delay)if(this.delayTimes){var a=t.delay<this.delayTimes.length?t.delay:0;u=this.delayTimes[a]}else u=t.delay/1e3;else u=.25;var i=t.outputs||[0,1],r=t.volume||.5,n=t.decrease||.5;this.delayDecrease=n,this.delayVolume=r,this.delayMaxDelay=10;var s,o,u=10;this.pingPongDelay=createGainNode(),this.output.connect(this.pingPongDelay,0,0);for(var l=1;l<=e;l++){s=audioContext.createDelay(this.delayMaxDelay),this.pingPongDelay.connect(s,0),s.delayTime.value=u*l,(o=createGainNode()).gain.value=r,r*=n,o.channelCount=1,o.channelCountMode="explicit",o.channelInterpretation="discrete",s.connect(o,0,0);var c=i[l%i.length];c=Math.min(c,maxChannelCount-1),o.connect(this.channelMerger,0,c),this.delayTaps.push({delay:s,gainObj:o,id:l})}},Bus.prototype.setDelay=function(t){if(this.delayTaps){var e;if("string"==typeof(t="object"==typeof t?t:{delay:t}).delay)e=this.getTime(t.delay);else if("number"==typeof t.delay)if(this.delayTimes){var a=Math.floor(t.delay*this.delayTimes.length);a=Math.max(0,Math.min(a,this.delayTimes.length-1));var i=this.delayTimes[a];e=this.getTime(i)}else e=t.delay/1e3;t.decrease&&(this.delayDecrease=t.decrease);var r=this.delayVolume;this.delayTaps.forEach(a=>{e&&a.delay.delayTime.linearRampToValueAtTime(a.id*e,audioContext.currentTime+1e-7),t.volume&&(r*=this.delayDecrease,a.gainObj.gain.linearRampToValueAtTime(t.volume*r,audioContext.currentTime+.001))})}else this.addSerialDelay(t)},Bus.prototype.addReverb=function(t){if(t&&("string"==typeof t&&(t={url:t}),t.url)){void 0===t.value&&(t.value=1);var e=this.sends[t.url];return e||(e=createGainNode(),this.sends[t.url]=e),e.gain.value=t.value,this.output.connect(e),t.src=e,{convolve:defaultInstance.addReverb(t),send:e}}},Bus.prototype.insertEffect=function(t,e){var a=audioContext.createBiquadFilter();this.inserts[0].disconnect(0),this.inserts.shift(a)},Bus.prototype.setPosition=function(t,e,a){this.panner.active||(this.filter.disconnect(0),this.filter.connect(this.panner),this.panner.active=!0),this.panner.setPosition(t,e,a)},Bus.prototype.addAnalyser=function(t,e,a){e=e||100;var i=audioContext.createAnalyser();this.input.connect(i),i.fftSize=a||2048;var r=i.frequencyBinCount,n=new Uint8Array(r);setInterval(function(){i.getByteTimeDomainData(n),t(n,r)},e)};var Sequence=function(t){this.iMusInstance=t.iMusInstance,this.objects=t.objects||[],this.firstOffset=t.firstOffset||0,this.loopEnd=t.loopEnd,this.timerIDs=[]};Sequence.prototype.maxUpbeatOffset=function(){},Sequence.prototype.play=function(){this.timerIDs.push(setTimeout(function(){},1e3))};var Envelope=function(t,e){Array.isArray(t)?(this.entries=[],this.target=e,t.forEach(t=>{this.entries.push(t)})):console.log("Error: Envelope requires an array with values - ",t)};Envelope.prototype.play=function(){this.target.cancelScheduledValues(0);var t=this.target.value,e=audioContext.currentTime,a=e;this.entries.forEach(i=>{t="number"==typeof i.value?i.value:t,i.delay?e+=i.delay:i.time&&(e=a+i.time),this.target.linearRampToValueAtTime(t,e)})},Envelope.prototype.stop=function(){this.target.cancelScheduledValues(0)};var iMus=function(o,b){var self=this;if(o=o||{},"string"==typeof o||Array.isArray(o))return new Selection(o,b);o.onLoadComplete=o.onLoadComplete||b,this.loadFile=loadFile,this.init=function(){initAudioContextTimer(this)},this.getBus=function(t){switch(t){case"sfx":return this.sfxBus;case"motif":return this.motifBus;default:if(t<=self.busses.length)return self.busses[t-1];this.parameters.destination=this.master.input,this.parameters.channelMerger=this.channelMerger;var e=new Bus(this.parameters);return self.busses[t]=e,e}},this.addSection=function(){var t;if(arguments.length){var e=Array.prototype.slice.call(arguments,0);"object"==typeof e[0]&&(e[0].url||(t=e.shift()))}(t=t||{}).urls||e.length&&(t.urls=e),void 0===t.upbeat&&(t.upbeat=self.upbeat),t.index=self.sections.length;var a=new Section(t);return self.sections.push(a),a},this.stop=function(){clearInterval(self.queueID),self.queueID=null,self.playing=!1},self.loadComplete=function(){switch(typeof self.parameters.onLoadComplete){case"function":self.parameters.onLoadComplete();break;case"string":iMus.play(self.parameters.onLoadComplete)}iMus.onload()},params=o||{},this.parameters=this.initParameters(o),self.volume=params.volume||1,self.parameters.tempo=params.tempo||120,self.parameters.timeSign=params.timeSign||"4/4",self.parameters.timeSign=getTimeSign(self.parameters.timeSign),self.upbeat="string"==typeof params.upbeat?this.getTime(params.upbeat):params.upbeat,self.upbeat=self.upbeat||0,self.externalOffset=params.offset,self.creationTime=(new Date).getTime(),self.parameters=this.initParameters(params),self.parameters.onLoadComplete=params.onLoadComplete,self.parameters.destination=iMus.master.output,self.parameters.volume=self.volume,self.master=new Bus(this.parameters),self.bus=self.master,self.master.output.channelCount=maxChannelCount,self.channelMerger=audioContext.createChannelMerger(Math.max(32,maxChannelCount)),self.channelMerger.channelCount=1,self.channelMerger.channelCountMode="explicit",self.channelMerger.channelInterpretation="discrete",self.channelMerger.connect(self.master.output),self.sendEffects={},self.selectFilter=[];for(var i=0;i<maxChannelCount;i++){var snd=audioContext.createBufferSource();snd.connect(self.channelMerger,0,i)}function queueNextPartOnTrack(t,e){var a,i,r=audioContext.currentTime,n=t.parts[e%t.parts.length];if(t.id<self.busses.length)self.busses[t.id];if(t.id,r+timeWindow>=t.nextTime+n.offset)return t.nextTime?(a=t.nextTime+n.offset,i=0):(a=audioContext.currentTime,self.sectionStart=a-n.offset,i=self.sectionStart),playSound(n,a),t.nextTime+n.length+i}self.transitionParts=[],self.sections=[],self.actions=[],self.currentSection,self.currentTransition,self.playing=!1,self.sectionStart=0,self.musicalStart=0,self.motifs=[],self.busses=[],self.intervalIDs=[],this.parameters.destination=self.master.input,this.parameters.channelMerger=self.channelMerger,self.sfxBus=new Bus(this.parameters),self.motifBus=new Bus(this.parameters),iMus.instances.push(this),this.checkQueue=function(){if(self.playing){var t=audioContext.currentTime,e=t-self.sectionStart;if(self.musicTime=e,self.currentSection)for(trackID in tracks=self.currentSection.tracks,tracks){var a=tracks[trackID],i=a.playing,r=!1,n=a.musicalPositionToTime(a.parameters.loopEnd),s=Math.floor(e/n),o=s*n,u=(e+1e3*n)%n;if(s!=a.loopID){!a.active&&a.parameters.fadeTime;var l=Math.random();a.playing=a.loopActive>l,r=!0,setTimeout(function(){a.eventHandler.execute("loopEnd")},1e3*n)}if(a.active,a.active>0&&a.playing&&!a.parameters.fadeTime||a.parameters.fadeTime)for(partID in a.parameters.fadeTime&&a.active>0&&0==a.playing&&a.fadeIn(),a.parts){var c=a.parts[partID];if(!c.playing&&!c.trigging||r){c.active=a.active,c.lastTriggedTime=c.lastTriggedTime||0,c.parameters.fadeTime=a.parameters.fadeTime;var f=(c.pos+c.offset+n)%n,p=f+n,h=u<=f&&u+timeWindow>f,d=u<=p&&u+timeWindow>p,m=a.parameters.fadeTime&&!i;if((h||d||m)&&s>=-1){var g=self.sectionStart+o+f+(d?n:0);if(a.parameters.fadeTime)for(;g<t;)g+=n;a.loopID=s;var v=Math.abs(c.lastTriggedTime-g);if(g<t)console.log("Negative time: "+(g-t));else if(v>0){a.playingParts.push(c),c.lastTriggedTime=g,c.parameters.retrig=a.parameters.retrig;var y=playSound(c,g,null,null,a);switch(iMus.debug&&console.log("newLoop",r,a.loopID),a.parameters.retrig){case"next":case"other":case"shuffle":case"repeat":if(c.parameters.activeVariations)if(c.counter%c.parameters.repeat);else{var b=c.parameters.activeVariations.splice(c.rndID,1)[0];c.parameters.activeVariations.push(b)}else{var T=c.url.indexOf(y);y=c.url.splice(T,1)[0],c.url.push(y)}}}}}}}}};var Section=function(t){this.id=t.index,this.volume=t.volume||1,void 0===t.upbeat?this.upbeat=self.upbeat:this.upbeat=self.getTime(t.upbeat),this.tracks=[],this.transitions=[],this.leadIns=[],this.idName=t.id||"",this.tags=t.tags||t.class||urlsToTags(t.urls),"string"==typeof this.tags&&(this.tags=this.tags.split(" ")),this.parameters=this.initParameters(t,self.parameters),t.loopEnd=t.loopEnd||t.end||defaultParams.loopEnd,this.parameters.loopEnd=this.getPosition(t.loopEnd).time,this.type="section",this.addStem=function(e){if(e instanceof Array)e[0].url||"string"==typeof e[0]||(t=e.shift());else{var a=Array.prototype.slice.call(arguments,0);"object"==typeof a[0]&&(a[0].urls||(t=a.shift())),a.length&&(e=a[0]instanceof Array?a[0]:a[0]instanceof Object?a[0].urls||[]:a)}var i,r="object"==typeof t?t:{},n=this.tracks.length;r.loopActive="number"==typeof r.loopActive?r.loopActive:1,r.active="number"==typeof r.active?r.active:1,r.destination=r.destination||self.master.input,r.channelMerger=r.channelMerger||self.channelMerger,r.timeSign=r.timeSign||this.parameters.timeSign,r.tempo=r.tempo||this.parameters.tempo,r.upbeat=r.upbeat||this.parameters.upbeat,r.audioPath=r.audioPath||this.parameters.audioPath,r.partLength=r.partLength||this.parameters.partLength,r.loopLength&&(r.loopEnd=this.divisionToTime(String(r.loopLength))),r.loopEnd=r.loopEnd||this.parameters.loopEnd,r.volume="number"==typeof r.volume?r.volume:this.parameters.volume,i=new Bus(r),self.busses.push(i);var s=this.createParts(e,r,i,this);if(r.index=n,s.length){r.parts=s,r.bus=i;var o=new Track(r,this);return r.fadeTime&&o.setVolume(0,!0),this.tracks.push(o),o}},t&&t.urls&&t.urls.length&&this.addStem(t),this.addTransition=function(t){var e=Array.prototype.slice.call(arguments,0),a=e.shift(),i=e[0];if(i instanceof Object)if(i.url);else var r=e.shift();void 0===(r=r||{}).upbeat&&(r.upbeat=self.upbeat),r.urls=e,r.index=self.sections.length,this.transitions[a.id]=new Section(r)};var e=!1;this.setOffset=function(t){self.sectionStart;if("number"==typeof t)self.sectionStart=audioContext.currentTime-t/1e3;else if(void 0!==self.externalOffset){var e=((new Date).getTime()-self.creationTime+self.externalOffset)/1e3;self.sectionStart=audioContext.currentTime-e}else{var a=getMaxUpbeatOffset(this.tracks);self.sectionStart=audioContext.currentTime+a+timeWindow}return self.sectionStart},this.stop=function(t){e=!1,self.queueID&&clearInterval(self.queueID),self.queueID=null,self.playing&&self.currentSection==this&&(this.postSection?this.postSection.play(1):self.stop()),self.playing=!1,this.tracks.forEach(function(t){t.parts.forEach(function(t){t.counter=0})})},this.queue=function(){this.play(1)},this.replay=function(){this.stop(),this.play()},this.play=function(t,a){if(!(e||self.currentSection==this&&self.playing)){variableWatcher.update(!0),self.playing||(initAudioContextTimer(self),self.queueID||(this.tracks.forEach(function(t){t.nextTime=0}),self.queueID=setInterval(self.checkQueue,checkQueueTime),self.checkQueue()));this.getBarDuration();var i,r=this;if(self.currentSection&&self.playing){var n=this.getMaxUpbeatOffset(),s=this.getMaxFadeTime(),o=self.currentSection.getNextLegalBreak(n+s+audioContext.currentTime),u=o.time,l=o.timeLeft,c=self.currentSection.getMaxUpbeatOffset(),f=self.currentSection.getMaxFadeTime(),p=this.getMaxLeadInUpbeatOffset(),h=this.getMinLeadInUpbeatOffset(),d=(Math.max(n,c,s,f),Math.max(timeWindow+.001,Math.min(l-p,l-h)));setTimeout(function(){h<l&&!a&&r.leadIns.forEach(function(t){t.play()})},Math.max(1,1e3*(d-timeWindow))),self.currentSection.finishPlaying(l),self.sectionStart=u,this.tracks.forEach(function(t){t.parameters.fadeTime&&(t.parts.forEach(function(t){}),t.active>0&&t.fadeIn())})}else{u=this.setOffset();self.playing||(self.musicalStart=u)}if(self.playing=!0,t>0)self.sectionStart=u,this.schedule(t),self.sectionStart+=this.length*t;else{for(var m in i=i||0,this.tracks){var g=this.tracks[m];g.currentPartID=i,g.nextTime=u}self.currentSection=this}e=!0,setTimeout(function(){e=!1},200)}}};function getNextLegalBreak(t,e){var a,i=(t=t||audioContext.currentTime)-self.sectionStart,r=this.divisionToTime(this.parameters.changeOnNext);return(a={}).time=self.sectionStart+Math.ceil(i/r)*r,a.timeLeft=a.time-audioContext.currentTime,a.fadeTime=this.parameters.fadeTime||.01,a.fadeTime=Math.min(a.fadeTime,a.timeLeft),a}Section.prototype.stopAllSounds=function(){this.stop(),this.tracks.forEach(function(t){t.stopAllSounds()})},Section.prototype.addLoopTrack=function(t){"string"==typeof t&&(t=[t]);var e=mergeArrays(urlsToTags(t),this.tags);return this.addStem({tags:e},t)},Section.prototype.addMotif=function(t,e){return defaultInstance.addMotif(t,e,this)},Section.prototype.addStingerTrack=function(t){var e=urlsToTags(t);return self.addMotif({tags:e},t)},Section.prototype.addTrackGroup=function(t){var e=new Selection(t,this.tracks);e.group(),e.objects.forEach(function(t,e){var a=0==e?1:0;t.setActive(a)})},Section.prototype.schedule=function(t){var e=this.parameters.loopEnd*t;for(trackID in this.tracks)for(var a=self.sectionStart,i=this.tracks[trackID],r=0;a<e;r++){var n=r*i.parameters.loopEnd;for(partID in i.parts){var s=i.parts[partID];s.active=i.active;var o=s.pos+s.offset;playSound(s,self.sectionStart+n+o)}}},Section.prototype.getNextLegalBreak=getNextLegalBreak,Section.prototype.finishPlaying=function(t){this.tracks.forEach(function(e){e.finishPlaying(t)})},Section.prototype.addLeadIn=function(t,e){t.quantize=t.quantize||"bar";var a=self.addLeadIn(t,e);return a.parameters.type="leadIn",this.leadIns.push(a),a},Section.prototype.getMaxLeadInUpbeatOffset=function(){var t=0;return this.leadIns.forEach(function(e){t=Math.max(t,e.getMaxUpbeatOffset())}),t},Section.prototype.getMinLeadInUpbeatOffset=function(){var t=this.getBarDuration();return this.leadIns.forEach(function(e){t=Math.min(t,e.getMinUpbeatOffset())}),t},Section.prototype.setTempo=function(t){this.parameters.tempo=t,this.tracks.forEach(function(e){e.parameters.tempo=t,e.parts.forEach(function(e){e.parameters.tempo=t})})},Section.prototype.initParameters=initParameters,Section.prototype.addDefaultParameters=addDefaultParameters,Section.prototype.getBeatDuration=getBeatDuration,Section.prototype.getBarDuration=getBarDuration,Section.prototype.getPosition=getPosition,Section.prototype.createParts=createParts,Section.prototype.getTime=getTime,Section.prototype.set=set,Section.prototype.setParams=setParams,Section.prototype.get=get,Section.prototype.map=map,Section.prototype.getMaxUpbeatOffset=getMaxUpbeatOffset,Section.prototype.getMaxFadeTime=getMaxFadeTime,Section.prototype.musicalPositionToTime=musicalPositionToTime,Section.prototype.divisionToTime=divisionToTime;var Track=function(t,e){params=t||{},this.id=params.index,this.parts=params.parts,this.nextTime=0,this.currentPartID=0,this.tags=params.tags||params.class||"","string"==typeof this.tags&&(this.tags=this.tags.split(" ")),this.idName=params.id||"",this.playingParts=[],this.groups=[],this.section=e,this.type="track",this.liveValues={},this.bus=t.bus||self.getBus(this.id),this.volume="number"==typeof t.volume?t.volume:1,this.bus.output.gain.value=this.volume,this.loopID,this.loopActive="number"==typeof t.loopActive?t.loopActive:1,this.playing=!1,"boolean"==typeof params.active?this.active=params.active?1:0:"number"==typeof params.active?this.active=params.active>1?1:params.active<-1?-1:params.active:this.active=1,params.fadeTime&&(params.fadeTime=params.fadeTime/1e3),this.parameters=this.initParameters(params,e.parameters);self.getBeatDuration();var a=self.getBarDuration();switch(this.parameters.loopEnd=params.loopEnd||e.parameters.loopEnd||self.parameters.loopEnd||defaultParams.loopEnd,typeof params.loopEnd){case"string":this.parameters.loopEnd=this.musicalPositionToTime(t.loopEnd);break;case"number":break;default:if(this.parts.length){var i=this.parts[this.parts.length-1];i.length=i.length||a,this.parameters.loopEnd=i.pos+i.length}else this.parameters.loopEnd=a}this.eventHandler=new EventHandler};Track.prototype.play=function(){self.playing,initAudioContextTimer(self);if(this.active>0)this.parameters.fadeTime&&this.fadeIn();else if(0==this.active?this.active=1:this.active=-this.active,self.playing&&this.parameters.fadeTime){var t;(t=this.getNextLegalBreak())||((t=this.section.getNextLegalBreak()).fadeTime=this.parameters.fadeTime);var e=t.time-audioContext.currentTime;this.fade(1,e,t.fadeTime)}},Track.prototype.stop=function(){if(!(this.active<=0)&&(this.active=-this.active,this.parameters.fadeTime))if(self.playing){var t=this.getNextLegalBreak();this.fade(0,t.timeLeft,t.fadeTime),this.playing=!1}else this.fade(0,0,0)},Track.prototype.stopAllSounds=function(){this.finishPlaying(0)},Track.prototype.finishPlaying=function(t){var e=this.parameters.fadeTime,a=this;e&&(this.playing=!1,this.fade(0,t,e,function(){a.parts.forEach(function(t){if(t.playingSources)for(;t.playingSources.length;){var e=t.playingSources.shift();e.disconnect(0),e=0}})}))},Track.prototype.setVariation=function(t,e){this.parts.forEach(function(a){a.variation=t,a.variationMaster="master"==e})},Track.prototype.setSoloState=function(t,e){if(this.soloGroups){var a=getSoloState(this.soloGroups,t,e);!0===a?this.play():!1===a&&this.stop()}},Track.prototype.setPartLength=function(t){t=this.divisionToTime(t),this.parts.forEach(function(e){e.length=t})},Track.prototype.setUpbeat=function(t){t=this.divisionToTime(t),this.parts.forEach(function(e){e.offset=-t})},Track.prototype.setRepeat=function(t){this.parts.forEach(function(e){e.parameters.repeat=t,e.counter=0})},Track.prototype.update=function(t){this.parts=this.createParts(t,this.parameters,this.bus,this)},Track.prototype.getNextLegalBreak=getNextLegalBreak,Track.prototype.initParameters=initParameters,Track.prototype.addDefaultParameters=addDefaultParameters,Track.prototype.getBeatDuration=getBeatDuration,Track.prototype.getBarDuration=getBarDuration,Track.prototype.getPosition=getPosition,Track.prototype.setActive=setActive,Track.prototype.createParts=createParts,Track.prototype.getTime=getTime,Track.prototype.setVolume=setVolume,Track.prototype.getVolume=getVolume,Track.prototype.fade=fade,Track.prototype.fadeIn=fadeIn,Track.prototype.fadeOut=fadeOut,Track.prototype.musicalPositionToTime=musicalPositionToTime,Track.prototype.setParams=setParams,Track.prototype.set=set,Track.prototype.map=map,Track.prototype.divisionToTime=divisionToTime,Track.prototype.get=get,Track.prototype.setSoloGroup=setSoloGroup,Track.prototype.urlToUpbeat=urlToUpbeat,Track.prototype.setActiveVariations=function(t){this.parameters.activeVariations=t,this.parts.forEach(function(e){e.parameters.activeVariations=t})};var Part=function(t,e,a,i){var r=this;t instanceof Array?t={url:t}:"string"==typeof t&&(t={url:t}),t=t||{},e=e||{},this.parameters=this.initParameters(e);var n=getBeatDuration(e);getBarDuration(e);"string"==typeof e.timeSign&&(e.timeSign=getTimeSign(e.timeSign));var s;e.timeSign||self.parameters.timeSign;upbeat=t.upbeat||e.upbeat||self.parameters.upbeat||e.upbeat,"string"==typeof upbeat?(upbeat=getTimeSign(upbeat),upbeat=upbeat.nominator*n*self.parameters.timeSign.denominator/upbeat.denominator):"number"==typeof upbeat&&(upbeat/=1e3),this.offset=-upbeat||0,"string"==typeof t.pos?i=this.musicalPositionToTime(t.pos):"number"==typeof t.pos&&(i=t.pos),this.pos=i,s="number"==typeof t.length?t.length:divisionToTime(s=t.length||e.partLength,e.timeSign,n),this.length=s;var o="string"==typeof t.url?[t.url]:t.url,u=[];for(var l in this.files=[],o.forEach(function(t){u.push(t)}),this.url=u,this.url)if("string"==typeof this.url[l]&&this.url[l].length){var c=addAudioPath(e.audioPath,this.url[l]);this.url[l]=c,self.loadFile({url:this.url[l]},function(t){r.files.push(t),loadComplete()}),console.log(this.url[l]+": pos: "+this.pos+"; offset: "+this.offset+"; length: "+this.length)}this.id=t.index,this.parameters.destination=a.input,this.parameters.channelMerger=self.channelMerger,this.bus=new Bus(this.parameters)};Part.prototype.fade=fade,Part.prototype.initParameters=initParameters,Part.prototype.addDefaultParameters=addDefaultParameters,Part.prototype.getBeatDuration=getBeatDuration,Part.prototype.getBarDuration=getBarDuration,Part.prototype.getPosition=getPosition,Part.prototype.setActive=setActive,Part.prototype.musicalPositionToTime=musicalPositionToTime;var Motif=function(t,e){this.id=self.motifs.length,this.section=e,this.type="motif";var a,i,r=this,n=self.getBeatDuration(),s=e||defaultInstance;for(var o in t.quantize=getTimeSign(t.quantize||s.parameters.quantize||self.parameters.quantize,s.parameters.timeSign),this.volume=t.volume||1,this.parameters=this.initParameters(t,self.parameters),this.loop=t.loop||0,this.loop="off"==this.loop?0:this.loop,this.loopCnt=0,this.idName=t.id||"",this.tags=t.tags||urlsToTags(t.urls)||[],"string"==typeof this.tags&&(this.tags=this.tags.split(" ")),this.parameters.destination=self.motifBus.input,this.parameters.channelMerger=self.channelMerger,this.bus=new Bus(this.parameters),this.active="number"==typeof t.active?t.active:1,this.sounds=[],this.offset=-self.getTime(this.parameters.upbeat),t.urls){if("string"==typeof(i=t.urls[o]))(a={}).url=addAudioPath(self.parameters.audioPath,i),a.offset=-this.urlToUpbeat(i)||this.offset;else if("object"==typeof i){if((a=i).url=addAudioPath(self.parameters.audioPath,a.url),a.length){var u=getTimeSign(a.length);a.length=u.nominator*n*self.parameters.timeSign.denominator/u.denominator}a.offset=-self.getTime(a.upbeat||this.parameters.upbeat),a.offset=a.offset||0}else console.error("Motif url is not correct: "+i);self.loadFile(a),this.sounds.push(a)}r.triggedRecently=!1,this.play=function(){if((!this.section||this.section.parameters.tags==defaultSectionName||this.section==self.currentSection)&&this.active){this.parameters.release&&this.fadeOut(0,this.parameters.release);var t=this.parameters.blockRetrig||0;if(arguments.length){var e=Array.prototype.slice.call(arguments,0);if("number"==typeof e[0]&&(t=e.shift()),"string"==typeof e[0])switch(e.shift()){case"loop":this.loop=-1}"function"==typeof e[0]&&(this.callBackOnFinish=e.shift())}if(!r.triggedRecently){if(r.playing=!0,self.currentSection&&"off"!=this.parameters.quantize){var a=self.currentSection.getBeatDuration(),i=this.parameters.quantize.nominator*a*self.currentSection.parameters.timeSign.denominator/this.parameters.quantize.denominator,n=self.currentSection.getTime(),s=Math.ceil(n/i)*i+self.sectionStart,o=(n+i)%i,u=i-o;this.sounds.sort(function(t,e){var a=i+t.offset-o;a=a<0?a+i:a;var r=i+e.offset-o;return a-(r=r<0?r+i:r)})}else u=0;for(var l=[],c=0;c<this.sounds.length;c++){var f=this.sounds[c];l.length?f.offset==l[0].offset&&l.push(f):l.push(f)}for(var p in this.url=[],l){var h=l[p];this.url.push(h)}if("off"!=this.parameters.quantize){var d=s+h.offset;if("leadIn"!=this.parameters.type)for(;d<audioContext.currentTime;)d+=i;else if(d<audioContext.currentTime)return void console.log(`Too late: ${audioContext.currentTime,h.offset}`)}else d=audioContext.currentTime;var m=this,g=playSound(this,d,this.callBackOnStart,function(){switch(r.loop){case-1:r.playing&&r.play();break;case 0:r.playing=!1;break;default:r.loopCnt++,r.loopCnt<=r.loop?r.play():(r.playing=!1,r.loopCnt=0)}m.callBackOnFinish&&m.callBackOnFinish()});switch(this.parameters.retrig){case"next":case"shuffle":case"repeat":case"other":c=this.sounds.indexOf(g);g=this.sounds.splice(c,1)[0],this.sounds.push(g)}return t&&(r.triggedRecently=!0,setTimeout(function(){r.triggedRecently=!1},1e3*t)),1e3*u}console.log("trigged recently")}},this.stop=function(){r.playing=!1,r.triggedRecently=!1;var t=this.bus.output;fadeAudioNode(t,1,0,.01),r.playingSources&&setTimeout(function(){r.playingSources.forEach(function(t){t.disconnect(0)}),fadeAudioNode(t,0,1,0)},20)}};this.addMotif=function(){var t={};if(!arguments.length)return-1;var e=Array.prototype.slice.call(arguments,0);e[0]instanceof Object&&(e[0].url||(t=e.shift())),Array.isArray(e[0])?t.urls=e[0]:t.urls=e;var a=e[1],i=new Motif(t,a);return self.motifs.push(i),i},Motif.prototype.getMaxUpbeatOffset=function(){var t=0;return this.sounds.forEach(function(e){t=Math.min(t,e.offset)}),-t},Motif.prototype.getMinUpbeatOffset=function(){var t=-this.getBarDuration();return this.sounds.forEach(function(e){t=Math.max(t,e.offset)}),-t},Motif.prototype.setSoloState=function(t,e){var a=getSoloState(this.soloGroups,t,e);!0!==a&&!1!==a||(this.active=a)},this.addLeadIn=this.addMotif,Motif.prototype.initParameters=initParameters,Motif.prototype.addDefaultParameters=addDefaultParameters,Motif.prototype.getBeatDuration=getBeatDuration,Motif.prototype.getBarDuration=getBarDuration,Motif.prototype.getPosition=getPosition,Motif.prototype.setActive=setActive,Motif.prototype.setVolume=setVolume,Motif.prototype.getVolume=getVolume,Motif.prototype.setParams=setParams,Motif.prototype.set=set,Motif.prototype.map=map,Motif.prototype.fade=fade,Motif.prototype.fadeIn=fadeIn,Motif.prototype.fadeOut=fadeOut,Motif.prototype.setActiveVariations=setActiveVariations,Motif.prototype.get=get,Motif.prototype.urlToUpbeat=urlToUpbeat,Motif.prototype.setSoloGroup=setSoloGroup;var SFX=function(){for(var t in this.url=Array.prototype.slice.call(arguments,0),this.bus=new Bus({destination:self.sfxBus.input,channelMerger:self.channelMerger}),this.url)this.url[t]=addAudioPath(self.parameters.audioPath,this.url[t]),self.loadFile({url:this.url[t]});var e=!1;return this.play=function(){var t=this.parameters.blockRetrig;if(arguments.length){var a=Array.prototype.slice.call(arguments,0);if("number"==typeof a[0]&&(t=a.shift()),"function"==typeof a[0])var i=a.shift()}e||(t=t||500,playSound(this,audioContext.currentTime,null,i),e=!0,setTimeout(function(){e=!1},t))},this};function posStringToObject(pos){if(obj={},obj.bar=1,obj.beat=1,obj.offBeat=0,"string"==typeof pos){var delimiter=-1!=pos.indexOf(",")?",":".";pos=pos.split(delimiter),pos.length&&(obj.bar=eval(pos[0])),pos.length>1&&(obj.beat=eval(pos[1])),pos.length>2&&(obj.offBeat=eval("."+pos[2]))}return obj}function musicalPositionToTime(t){var e=0;switch(typeof t){case"string":var a=posStringToObject(t),i=this.getBeatDuration();e=this.getBarDuration()*(a.bar-1)+i*(a.beat-1)+i*a.offBeat;break;case"number":e=t}return e}function createParts(t,e,a){for(var i=[],r=0,n=0;n<t.length;n++)if(t[n]){var s=new Part(t[n],e,a,r);i.push(s),r=s.pos+s.length}return i}SFX.prototype.setVolume=setVolume,SFX.prototype.getVolume=getVolume,SFX.prototype.get=get,this.addSFX=function(){function t(t){return SFX.apply(this,t)}return t.prototype=SFX.prototype,function(){return new t(arguments)}}()};iMus.prototype.initParameters=initParameters,iMus.prototype.addDefaultParameters=addDefaultParameters,iMus.prototype.getBeatDuration=getBeatDuration,iMus.prototype.getBarDuration=getBarDuration,iMus.prototype.getTime=getTime,iMus.prototype.addSuffix=addSuffix,iMus.prototype.getPosition=getPosition,iMus.prototype.divisionToTime=divisionToTime,iMus.prototype.fade=fade,iMus.prototype.fadeOut=fadeOut,iMus.prototype.fadeIn=fadeIn,iMus.prototype.setOffset=function(t){var e;for(var a in this.sections){e=this.sections[a].setOffset(t)}return e},iMus.prototype.find=find,iMus.prototype.play=function(t){this.sections.length&&this.sections[0].play()},iMus.prototype.call=function(t,e){new Selection(t,this).play(e)},iMus.prototype.addAction=addAction,iMus.prototype.addReverb=function(t){if(t&&t.url&&t.src){var e=addAudioPath(this.parameters.audioPath,t.url),a=this.sendEffects[e],i=this;return a||(a=audioContext.createConvolver(),this.sendEffects[e]=a,this.loadFile({url:e},function(){var r=buffers[e];audioContext.createBufferSource().buffer=r,a.buffer=r,a.loop=!0,a.normalize=!0,a.connect(t.output||i.master.output)})),t.src.connect(a),a}},iMus.addLFO=addLFO,iMus.addEnvelope=function(t,e){return new Envelope(t,e)},iMus.prototype.setTempo=function(t){this.sections.forEach(function(e){e.setTempo(t)})},iMus.setTempo=function(t){this.instances.forEach(function(e){e.setTempo(t)})},iMus.timeToNext=function(t){return defaultInstance.timeToNext(t)},iMus.prototype.timeToNext=function(t){return 1e3*this.divisionToTime(t)},iMus.solo=function(t,e){this.instances.forEach(a=>{a.sections.forEach(i=>{i.parameters["select-group"]==t&&i.parameters["select-value"]==e&&(a.playing?i.play():a.currentSection=i),i.tracks.forEach(a=>a.setSoloState(t,e))}),a.motifs.forEach(a=>a.setSoloState(t,e))})},iMus.prototype.on=function(t,e,a,i){if(e){a=a||0,a/=1e3,i=i||-1;var r,n=this,s=1;switch(typeof t){case"string":if(stringIsTimeSign(t)){r=this.divisionToTime(t)}break;case"number":r=t/1e3;break;default:return}var o=function(){var t=n.musicalStart+r*s+a-audioContext.currentTime;s++,setTimeout(function(){e(),(s<=i||-1==i)&&o()},1e3*t)},u=function(){n.playing?o():setTimeout(u,100)};return u(),r}};var Action=function(t,e){return this.idName=t,this.tags=t.split(" "),this.play=e,this},Selection=function(t,e){var a,i,r=[];switch(this.objects=[],typeof t){case"string":break;case"object":t=t.join(" ");break;default:return this}if(!t.length)return this;switch(typeof t){case"string":switch(this.selector=t,(t=t.split(" ").shift()).substr(0,1)){case"#":a="id",t=t.substr(1);break;case".":a="class",t=t.substr(1);break;default:a="class",t=this.selector}break;default:return this}i=e instanceof iMus?[e]:iMus.instances,e instanceof Selection?r=e.objects:e instanceof Array?r=e:i.forEach(function(t){t.sections.forEach(function(t){r.push(t),t.tracks.forEach(function(t){r.push(t)})}),t.motifs.forEach(function(t){r.push(t)}),t.actions.forEach(function(t){r.push(t)})});var n=[];return r.some(function(e){switch(a){case"id":e.idName==t&&n.push(e);break;case"class":if(inArray(t,e.tags)){if("section"==e.type)return n=[e],!0;n.push(e)}break;case"objectType":switch(t){case"track":case"stem":e instanceof Track&&n.push(e);break;case"motif":e instanceof Motif&&n.push(e)}}}),this.objects=n,this};Selection.prototype.createDefaultSectionIfNeeded=function(){if(!this.objects.length){var t=defaultInstance.addSection({tags:this.selector});defaultInstance.currentSection||(defaultInstance.currentSection=t),this.objects.push(t)}},Selection.prototype.addLoopTrack=function(t){var e;return this.createDefaultSectionIfNeeded(),t||(t=[]),this.objects.forEach(function(a){a.addLoopTrack&&(e=a.addLoopTrack(t))}),this.objects=[e],this},Selection.prototype.addLFO=function(t,e,a,i,r){return this.objects.forEach(function(n){n.addLFO&&n.addLFO(t,e,a,i,r)}),this},Selection.prototype.addDelay=function(t){return this.objects.forEach(function(e){e.bus&&e.bus.addSerialDelay(t)}),this},Selection.prototype.addReverb=function(t){return this.objects.forEach(function(e){e.bus&&e.bus.addReverb(t)}),this},Selection.prototype.addMotif=function(t,e,a){"string"==typeof t&&(t=[t]),this.createDefaultSectionIfNeeded();var i=urlsToTags(t);this.objects.length&&(i=mergeArrays(i,this.objects[0].tags));var r=this.objects.find(function(t){return"function"==typeof t.addMotif})||defaultInstance,n="object"==typeof e?e:{};n.tags=n.tags||i,n.quantize=n.quantize||e,n.upbeat=n.upbeat||a;var s=r.addMotif(n,t);return this.objects=[s],this},Selection.prototype.addLeadIn=function(t,e){return e="object"==typeof e?e:{quantize:"bar",type:"leadIn"},this.addMotif(t,e),this},Selection.prototype.loadFile=function(t){return this.addMotif(t,"off"),this},Selection.prototype.setSoloGroup=function(t,e){this.objects.forEach(function(a){a.setSoloGroup&&a.setSoloGroup(t,e)})},Selection.prototype.solo=function(t){return this.stop(),this.find(t).play(),this},Selection.prototype.play=function(t,e,a){var i={};return this.objects.forEach(function(r){r.play&&(i.delay=r.play(t,e,a))}),this.returnVal=i,this},Selection.prototype.trig=Selection.prototype.play,Selection.prototype.replay=function(){return this.objects.forEach(function(t){if(t.replay)return t.replay()}),this},Selection.prototype.stop=function(t){return t=t||{},this.objects.forEach(function(e){if(e.stop&&e!=t.omit)return e.stop()}),this},Selection.prototype.stopAllSounds=function(){return this.objects.forEach(function(t){t.stopAllSounds&&t.stopAllSounds()}),this},Selection.prototype.isPlaying=function(){var t=!1;return this.objects.forEach(function(e){var a=e.isPlaying?e.isPlaying():e.playing;t=t||a}),t},Selection.prototype.setActive=function(t){return this.objects.forEach(function(e){if(e.setActive)return e.setActive(t)}),this},Selection.prototype.setOutput=function(t,e){return this.objects.forEach(function(a){if(a.bus)return a.bus.setOutput(t,e)}),this},Selection.prototype.setVolume=function(t,e){return this.objects.forEach(function(a){if(a.setVolume)return a.setVolume(t,e)}),this},Selection.prototype.getVolume=function(){var t=-1;return this.objects.forEach(function(e){if(!e.getVolume)return-1;t=Math.max(t,e.getVolume())}),t},Selection.prototype.fade=function(t,e,a){return e=e||0,a=a||250,a/=1e3,this.objects.forEach(function(i){if(i.fade)return i.fade(t,e,a)}),this},Selection.prototype.fadeIn=function(){return this.objects.forEach(function(t){if(t.fadeIn)return t.fadeIn()}),this},Selection.prototype.fadeOut=function(t,e){return t&&(t/=1e3),e&&(e/=1e3),this.objects.forEach(function(a){if(a.fadeOut)return a.fadeOut(e,t)}),this},Selection.prototype.setVariation=function(t,e){return this.objects.forEach(function(a){"function"==typeof a.setVariation?a.setVariation(t,e):a.variation=t}),this},Selection.prototype.setActiveVariations=function(t){return this.objects.forEach(function(e){if(e.setActiveVariations)return e.setActiveVariations(t)}),this},Selection.prototype.get=function(t,e){var a;return this.objects.forEach(function(i){i.get&&(a=i.get(t,e))}),a},Selection.prototype.setParams=function(t){return this.objects.forEach(function(e){if(e.setParams)return e.setParams(t)}),this},Selection.prototype.set=function(t,e,a){return this.createDefaultSectionIfNeeded(),this.objects.forEach(function(i){if(i.set)return i.set(t,e,a)}),this},Selection.prototype.map=function(t,e,a,i,r,n,s){return this.objects.forEach(function(o){if(o.map)return o.map(t,e,a,i,r,n,s)}),this},Selection.prototype.find=find,Selection.prototype.group=function(){var t=this;return this.objects.forEach(function(e){e.groups&&e.groups.push(t)}),this},Selection.prototype.addTrackGroup=function(t){return this.objects.forEach(function(e){e.addTrackGroup&&e.addTrackGroup(t)}),this},Selection.prototype.getPosition=function(t,e){var a;return this.objects.length||(this.objects=[defaultInstance]),this.objects.forEach(function(i){i.getPosition&&(a=i.getPosition(t,e))}),a},Selection.prototype.on=function(t,e,a){this.objects.forEach(function(i){i.eventHandler&&i.eventHandler.addEvent(t,e,a)})},Selection.prototype.update=function(t){return this.objects.forEach(function(e){e.update&&e.update(t)}),this};var Event=function(t,e){this.fn=t,this.delay=e||0},EventHandler=function(){return this};EventHandler.prototype.addEvent=function(t,e,a){"function"==typeof e&&(this[t]=this[t]||[],this[t].push(new Event(e,a)))},EventHandler.prototype.execute=function(t,e){var a=this[t];a&&a.forEach(function(t){setTimeout(function(){t.fn(e)},t.delay)})};var defaultParams={volume:1,pan:.5,tempo:120,audioPath:"audio",upbeat:0,partLength:"1/1",changeOnNext:"1/1",timeSign:{nominator:4,denominator:4},fadeTime:.01,offset:0,suffix:"mp3",loopActive:1,loopEnd:"5.1",activeRange:{}};defaultParams.activeRange.min=0,defaultParams.activeRange.max=1,defaultParams.activeRange.minVal=0,defaultParams.activeRange.maxVal=1,defaultParams.blockRetrig=0,defaultParams.repeat=1,defaultParams.retrig="shuffle",defaultParams.release=0,defaultParams.quantize="1/8";var masterBus=new Bus;masterBus.output.channelCount=maxChannelCount,iMus.master=masterBus,iMus.audioContext=audioContext,iMus.instances=[],iMus.setOffset=function(t){for(var e,a=0;a<this.instances.length;a++){console.log("diff - "+new Date+" : "+a),e=this.instances[a].setOffset(t)}console.log("nextTime: "+e)},iMus.setParams=setParams,iMus.set=function(t,e){var a=defaultInstance.sections.length-1,i=defaultInstance.sections[a].set(t,e);defaultInstance.parameters[i.param]=i.val,defaultParams[i.param]=i.val},iMus.select=function(t,e){var a=defaultInstance.selectFilter.find(e=>e.name==t);a?a.value=e:defaultInstance.selectFilter.push({name:t,value:e}),this.solo(t,e)},iMus.play=function(t,e,a,i){return t?new Selection(t,defaultInstance).play(e,a,i):defaultInstance.currentSection?void defaultInstance.currentSection.play():new Selection("default",defaultInstance).play(e,a,i)},iMus.stop=function(t){t?new Selection(t,defaultInstance).stopAllSounds():defaultInstance.currentSection.stopAllSounds()},iMus.isPlaying=function(){var t=!1;return this.instances.forEach(function(e){t=e.playing||t}),t},iMus.setInterval=function(t,e,a,i){return i=i||-1,defaultInstance.on(e,t,a,i)},iMus.setTimeout=function(t,e,a){return defaultInstance.on(e,t,a,1)},iMus.getPosition=function(t,e){return defaultInstance.getPosition(t,e)},iMus.clearTimeouts=function(){for(;defaultInstance.intervalIDs.length;){var t=defaultInstance.intervalIDs.pop();clearTimeout(t)}},iMus.getDefaultInstance=function(){return defaultInstance},iMus.fade=function(t,e,a){defaultInstance.fade(t,e,a)},iMus.fadeIn=function(t,e){defaultInstance.fadeIn(t,e)},iMus.fadeOut=function(t,e){defaultInstance.fadeOut(t,e)},iMus.createBus=function(){return defaultInstance.getBus()},audioContext.createBufferSource(),window.audioContext=audioContext,iMus.addLoopTrack=function(t){return iMus(defaultSectionName).addLoopTrack(t)},iMus.addTrackGroup=function(t){return iMus(defaultSectionName).addTrackGroup(t)},iMus.addMotif=function(t,e,a){return iMus.getDefaultInstance().addMotif(t,e,a)},iMus.loadJSON=function(t){var e=JSON.parse(t);this.loadData(e)},iMus.loadData=function(t){t.sections&&t.sections.forEach(function(t){t.tracks&&t.tracks.forEach(function(e){iMus(t.id).addLoopTrack(e.parts)}),t.motifs&&t.motifs.forEach(function(e){iMus(t.id).addMotif(e.urls,e.quantize)}),t.leadins&&t.leadins.forEach(function(e){iMus(t.id).addLeadIn(e.urls)}),t.sounds&&t.sounds.forEach(function(e){iMus(t.id).addMotif(e.urls,"off")})}),t.tracks&&t.tracks.forEach(function(t){iMus(defaultSectionName).addLoopTrack(t.parts)}),t.motifs&&t.motifs.forEach(function(t){defaultInstance.addMotif({quantize:t.quantize},t.urls)}),t.leadins&&t.leadins.forEach(function(t){defaultInstance.addLeadIn({quantize:"bar"},t.urls)}),t.sounds&&t.sounds.forEach(function(t){defaultInstance.addMotif({quantize:"off"},t.urls)})},iMus.loadFiles=function(t){var e=filesNamesTodata(t);this.loadData(e)},iMus.filesNamesTodata=filesNamesTodata,iMus.loadFile=function(t){var e,a,i,r,n,s=iMus(t);if(s.objects.length)return s;if(e=strToParamValue(t,SECTION),a=strToParamValue(t,TRACK),i=strToParamValue(t,MOTIF),r=strToParamValue(t,LEADIN),n=strToParamValue(t,SOUND),null!=e){var o=urlsToTags(t);defaultInstance.addSection({tags:o});if(null!=i)return iMus(o[0]).addMotif(t);if(null!=r)return iMus(o[0]).addLeadIn(t);if(null!=n)return iMus(o[0]).addMotif(t,"off");if(null!=a)return iMus(o[0]).addLoopTrack(t);var u=iMus(o[0]);return iMus(o[0]).addLoopTrack(t),u}if(null!=a)return iMus(defaultSectionName).addLoopTrack(t);if(null!=i){defaultInstance.addMotif({url:t});return new Selection(MOTIF+"-"+i)}if(null!=r){defaultInstance.addLeadIn({url:t});return new Selection(LEADIN+"-"+r)}if(null!=n){defaultInstance.addMotif({quantize:"off"},t);return new Selection(SOUND+"-"+n)}},iMus.addLeadIn=iMus.addMotif,iMus.addStingerTrack=iMus.addMotif,window.module?module.exports=iMus:(window.iMus=iMus,window.iMusic=iMus);var defaultInstance=new iMus;defaultInstance.addSection({tags:defaultSectionName}),iMus.addSection=defaultInstance.addSection,iMus.variations={},iMus.setVariation=function(t,e){iMus.variations[t]=e},iMus.getVariation=function(t){var e=iMus.variations[t];return e||(e=0),e=Math.min(e,Math.max(e,0))},setInterval(function(){},1e3),iMus.onload=function(){},document.addEventListener("click",function(){initAudioContextTimer()}),window.addEventListener("load",function(event){var meta=document.querySelectorAll("meta[name*='imusic-']");meta.forEach(function(el){var param=el.name.substr(7),strVal=el.content;val=eval(strVal),val!=strVal&&(val=strVal),iMusic.set(param,val)});var elements=document.querySelectorAll("[data-imusic]"),bgElements=[],lastTarget;elements.forEach(function(t){var e=iMusic.loadFile(t.dataset.imusic);switch(t.localName){case"body":defaultInstance.parameters.onLoadComplete=e.selector;break;case"a":t.attributes.href?"#"==t.attributes.href.nodeValue&&(t.attributes.href.nodeValue="javascript:void(0)"):t.setAttribute("href","javascript:void(0)"),t.addEventListener("click",function(a){iMus(e.objects[0].tags[0]).play(),"#"==t.attributes.href.nodeValue&&(a.preventDefault?a.preventDefault():a.returnValue=!1)});break;default:bgElements.push(t)}}),setInterval(function(){var t=document.querySelector("*:target");bgElements.includes(t)&&t!=lastTarget&&(lastTarget=t,iMus(t.dataset.imusic).play())},100)});class VariableWatcher{constructor(t){this.variables=[],this.instance=t,setInterval(()=>this.update(),timeWindow/2)}update(force){this.variables.forEach(varObj=>{let curVal=eval(varObj.name);(curVal!=varObj.val&&void 0!==curVal||1==force)&&(this.instance.select(varObj.name,curVal),varObj.val=curVal)})}addVariable(t){"window."!=t.substr(0,7)&&(t="window."+t);let e=this.variables.find(e=>t==e.name);e||((e={}).name=t,this.variables.push(e))}}var variableWatcher=new VariableWatcher(iMus),XMLtimeStamp=Date.now(),src=document.currentScript.dataset.musicStructure;src&&fetch(src).then(t=>t.text()).then(t=>{var e=(new DOMParser).parseFromString(t,"text/xml"),a=e.firstChild;iMus.setParams(a.attributes);var i,r,n,s=defaultInstance;a.querySelectorAll("arrangement").forEach((t,e)=>{var a=t.getAttribute("select-value");null==(i=t.getAttribute("src"))&&(i=void 0);var o=s.addSection({tags:a},i);o.setParams(t.attributes),"true"!=t.getAttribute("selected")&&0!=e||(s.currentSection=o),t.querySelectorAll("track").forEach(t=>{var e=[];(i=t.getAttribute("src"))&&e.push(i);var a=t.querySelectorAll("region");if("off"==(r=attributesToObject(t.attributes)).loop){r.type="leadIn",e=[],a.forEach(t=>{var a=t.getAttribute("upbeat"),i=t.getAttribute("src");i&&e.push({url:i,upbeat:a}),t.querySelectorAll("source").forEach(t=>{var i=t.getAttribute("upbeat")||a,r=t.getAttribute("src");r&&e.push({url:r,upbeat:i})})});var s=o.addLeadIn(r,e);if(t.hasAttribute("select-group")){var u=t.getAttribute("select-group"),l=t.getAttribute("select-value");s.setSoloGroup(u,l)}if(t.hasAttribute("select-variable")){u=t.getAttribute("select-variable"),l=t.getAttribute("select-value");let e="window.";u.substr(0,7)!=e&&(u=e+u),s.setSoloGroup(u,l)}}else{a.forEach(t=>{(n=attributesToObject(t.attributes),i=t.getAttribute("src"))||(i=[],t.querySelectorAll("source").forEach(t=>{var e=t.getAttribute("src");e&&i.push(e)}));n.url=i,e.push(n)});var c=o.addStem(r,e);if(t.hasAttribute("select-group")){u=t.getAttribute("select-group"),l=t.getAttribute("select-value");c.setSoloGroup(u,l)}if(t.hasAttribute("select-variable")){u=t.getAttribute("select-variable"),l=t.getAttribute("select-value");let e="window.";u.substr(0,7)!=e&&(u=e+u),c.setSoloGroup(u,l)}}}),t.querySelectorAll("motif").forEach(t=>{let e=[],a=attributesToObject(t.attributes),i=t.getAttribute("src");i&&e.push(i),t.querySelectorAll("source").forEach(t=>{var a=t.getAttribute("src");a&&e.push(a)});let r=o.addMotif(a,e);if(t.hasAttribute("select-group")){var n=t.getAttribute("select-group"),s=t.getAttribute("select-value");r.setSoloGroup(n,s)}if(t.hasAttribute("select-variable")){n=t.getAttribute("select-variable"),s=t.getAttribute("select-value");let e="window.";n.substr(0,7)!=e&&(n=e+n),r.setSoloGroup(n,s)}})}),e.querySelectorAll("*[selected='true']").forEach(t=>{let e=t.getAttribute("select-group");if(!e){let a="window.";(e=t.getAttribute("select-variable")).substr(0,7)!=a&&(e=a+e)}if(!e)return;let a=t.getAttribute("select-value");a&&iMus.select(e,a)}),e.querySelectorAll("*[select-variable]").forEach(t=>{variableWatcher.addVariable(t.getAttribute("select-variable"))}),console.log("XML parse time: "+(Date.now()-XMLtimeStamp))})}else alert("Web Audio API not supported. Please use another browser");function playSound(t,e,a,i,r){var n;if(e=e||0,r&&r.parameters.randomOffset&&(e+=Math.random()*r.parameters.randomOffset-r.parameters.randomOffset/2),e=Math.max(audioContext.currentTime,e),"object"==typeof t.url){var s;if("repeat"==t.parameters.retrig&&t.counter%t.parameters.repeat)iMus.debug&&console.log(t.counter,t.parameters.repeat);else s=t.parameters.activeVariations?t.parameters.activeVariations.length:"next"==t.parameters.retrig?0:void 0===t.rndID||t.url.length<3||"shuffle"==t.parameters.retrig?t.url.length:t.url.length-1,"number"==typeof t.variation?(p=t.variation,p=Math.max(0,p),p=Math.min(.9999999999,p)):"string"==typeof t.variation?1==t.variationMaster?(p=Math.random(),iMus.setVariation(t.variation,p)):p=iMus.getVariation(t.variation):p=Math.random(),t.rndID=Math.floor(p*s);t.parameters.activeVariations?(n=t.url[t.parameters.activeVariations[t.rndID]])||(n=t.url[0]):n=t.url[t.rndID]}else n=t.url;var o=t.length,u=n;"object"==typeof u&&(n=u.url,o=u.length||o);var l=Math.floor(1e3*(e-audioContext.currentTime)),c=0;if(buffers[n]){var f=audioContext.createBufferSource();t.playingSources=t.playingSources||[],f.buffer=buffers[n];var p,h=t.bus.input||iMus.master.input;if(f.connect(h),t.playing=!0,t.trigging=!0,t.playingSources.push(f),void 0===t.active&&(t.active=1),c=l+Math.floor(1e3*f.buffer.duration),(p=Math.random())<t.active||t.parameters.fadeTime){void 0===f.start?f.noteOn(e):f.start(e),t.counter=++t.counter||1,iMus.debug&&console.log(n),r&&setTimeout(function(){r.eventHandler.execute("playFile",n)},l);var d=new CustomEvent("iMusic",{detail:{command:"playFile",url:n}});setTimeout(function(){window.dispatchEvent(d,l)}),"function"==typeof a&&setTimeout(function(){a("playFile",n)},l)}else iMus.debug&&console.log("Not playing: "+n+", Math.random = "+p);setTimeout(function(){t.trigging=!1},2*timeWindow*1e3),"number"==typeof o&&setTimeout(function(){"function"==typeof i&&i(),t.playing=!1},l+1e3*o-1e3*timeWindow),setTimeout(function(){if(t.playing=!1,t.playingSources&&t.playingSources.length)t.playingSources.shift();f=null,"function"==typeof i&&void 0===o&&i()},c)}else iMus.debug&&console.log("Buffer not found: "+n);return u}function loadFile(t,e){e=e||loadComplete;var a=this.addSuffix(t.url);if("string"==typeof a)if(t.url in buffers);else{buffers[t.url]=0;var i=new XMLHttpRequest;i.open("GET",a,!0),i.responseType="arraybuffer";var r={};r.url=a,i.onload=function(){audioContext.decodeAudioData(i.response,function(a){a&&(buffers[t.url]=a,r.duration=a.duration,e(r))},function(){console.error('File "'+a+'" could not be decoded'),buffers[t.url]=-1,e()})},i.onerror=function(){console.error('File "'+a+'" could not be loaded'),buffers[t.url]=-1,e()},i.send()}}function loadComplete(){for(var t in buffers)if(0==buffers[t])return!1;for(var e in console.log("LoadComplete"),iMus.instances)iMus.instances[e].loadComplete();return!0}function addSuffix(t){switch(t.substr(-4)){case".wav":case".mp3":case".ogg":return t;default:return t+"."+this.parameters.suffix}}function setVolume(t,e){this.bus&&(this.bus.input.gain.linearRampToValueAtTime(t,audioContext.currentTime+.1),this.parameters&&!e&&(this.parameters.volume=t))}function getVolume(){return this.bus?this.bus.output.gain.value:-1}function setSoloGroup(_param1,_param2){var grp,valStr;_param2?(grp=_param1,valStr=_param2):(grp="default",valStr=_param1),this.soloGroups||(this.soloGroups=[]);var values=[],arr=valStr.split(",");arr.forEach(function(val){var numVal=eval(val);if(numVal==val)values.push(numVal);else if(val.indexOf("-")){var minMaxStrings=val.split("-"),numValMin=eval(minMaxStrings[0]),numValMax=eval(minMaxStrings[1]);values.push({min:numValMin,max:numValMax})}else values.push(val)}),this.soloGroups.push({name:grp,value:values})}function getSoloState(t,e,a){if(t){var i,r;void 0!==a?(i=e,r=a):(i="default",r=e);var n=t.find(t=>t.name==i);if(n){var s=!1;return n.value.forEach(function(t){r==t?s=!0:"object"==typeof t&&"number"==typeof t.min&&r>=t.min&&r<=t.max&&(s=!0)}),s}}}function addAction(t,e){this.actions.push(new Action(t,e))}function find(t){return new Selection(t,this)}function widthEndingSlash(t){return"/"==t.substring(t.length-1)?t:t+"/"}function addAudioPath(t,e){if(e.includes("//"))return e;var a=t.length;return(t=t==e.substr(0,a)?"":widthEndingSlash(t))+e}function urlToUpbeat(t){var e=t.match(/up-(\d+)/);if(!e)return 0;var a=Number(e.pop())||0;return this.getBeatDuration()*a}function strToParamValue(t,e){t=removeSuffix(t),e=e||"";var a=new RegExp(e+"-([A-Za-z0-9-.]+)"),i=t.match(a);if(i){var r=i.pop();switch(e){case QUANTIZE:case LENGTH:case UPBEAT:r=r.replace("-","/")}return r}}function urlsToFileNames(t){var e=[];return"string"==typeof t&&(t=[t]),(t=t||[]).forEach(function(t){if("object"==typeof t){if(t.url)if(t.url instanceof Array){var a=urlsToFileNames(t.url);e=e.concat(a)}else e.push(t.url);else if(t instanceof Array){a=urlsToFileNames(t);e=e.concat(a)}}else"string"==typeof t&&e.push(t)}),e}function removeSuffix(t){switch(t.substr(-4)){case".mp3":case".wav":case".ogg":case".aac":return t.substr(0,t.length-4);default:return t}}function urlsToTags(t){var e=[],a={},i=urlsToFileNames(t);return i.forEach(function(t){e.push(t),"."==t.substr(-4,1)&&(t=t.substr(0,t.length-4));var i=t.lastIndexOf("/");-1!=i&&(t=t.substr(i+1)),t.split("_").forEach(function(t){a[t]=a[t]||0,a[t]++})}),Object.keys(a).forEach(function(t){if(a[t]==i.length){e.push(t);var r=strToParamValue(t);r&&e.push(r)}}),e}function round(t,e){e=e||2;var a=Math.pow(10,e);return Math.floor(t*a)/a}function setActiveVariations(t){this.parameters.activeVariations=t}function getBellCurveY(t,e,a){a=a||!1,e=e||.125,t=Math.min(1,Math.max(t,0));return a?1/(1/(e*Math.sqrt(2*Math.PI))*Math.pow(Math.E,-1*Math.pow(t-.5,2)/(2*Math.pow(e,2)))):1/(e*Math.sqrt(2*Math.PI))*Math.pow(Math.E,-1*Math.pow(t-.5,2)/(2*Math.pow(e,2)))*getBellCurveY(.5,e,!0)}function getPosition(pos,flags){pos=pos||this.musicTime||audioContext.currentTime-this.sectionStart||audioContext.currentTime-self.sectionStart,obj={},obj.bar=1,obj.beat=1,flags=flags||{};var params=this.parameters,beatDuration=this.getBeatDuration(),barDuration=this.getBarDuration();switch(typeof pos){case"string":var delimiter=-1!=pos.indexOf(",")?",":".";pos=pos.split(delimiter),pos.length&&(obj.bar=eval(pos[0])),pos.length>1&&(obj.beat=eval(pos[1])),obj.time=barDuration*(obj.bar-1)+beatDuration*(obj.beat-1);break;case"number":switch(flags.roundTo){case"bar":pos+=barDuration/2;break;case"beat":pos+=beatDuration/2}var bar=Math.floor(pos/barDuration);obj.beat=Math.floor(pos/beatDuration)%params.timeSign.nominator+1,obj.bar=bar+1,obj.time=pos}return obj}function onEvent(t,e,a){this.eventHandler=this.eventHandler||new EventHandler,this.eventHandler.addEvent(t,e,a)}function getBeatDuration(t){return 60/(t=t||this.parameters).tempo}function getBarDuration(t){return getBeatDuration(t=t||this.parameters)*t.timeSign.nominator}function setActive(t){var e=this.parameters.activeRange;if(t<0)this.active=t;else if(t>=e.min&&t<=e.max){var a=e.max-e.min,i=t-e.min,r=e.maxVal-e.minVal;this.active=0==a?e.maxVal:e.minVal+i/a*r}else this.active=0;this.parameters.fadeTime&&(this.active>0?this.fadeIn():this.fadeOut())}function getTime(t){var e=(this.parameters||defaultParams).timeSign,a=(this.parameters||defaultParams).tempo;if(e||console.log(e),void 0===t)t=audioContext.currentTime-(self.sectionStart||defaultInstance.sectionStart);else if("string"==typeof t){var i=t.split("/");i.length<1?i=[0,e.denominator]:i.length<2&&(i[1]=e.denominator),t=60*(i[0]*e.denominator/i[1])/a}return t=t||0}function inArray(t,e){"object"!=typeof e&&console.log("no haystack");var a=t.split(" "),i=0;return a.forEach(function(t){var a=!1,r="*"==t.substr(0,1);r&&(t=t.substr(1)),e.forEach(function(e){r?e.substr(e.length-t.length)==t&&(a=!0):e==t&&(a=!0)}),a&&i++}),i>=a.length}function mergeArrays(t,e){return e.forEach(function(e){inArray(e,t)||t.push(e)}),t}function findAndReplace(t,e,a){var i=e.substr(0,1);return"#"!=i&&"."!=i||(e=e.substr(1)),"*"==e.substr(0,1)?(e=e.substr(1),a=a.substr(1),t.replace(e,a)):t}function initParameters(t,e){if(e=void 0===e?{}:JSON.parse(JSON.stringify(e)),"object"==typeof t)for(attr in t=JSON.parse(JSON.stringify(t)))e[attr]=t[attr];return this.addDefaultParameters(e),e}function addDefaultParameters(t){t.volume=t.volume||defaultParams.volume,t.pan="number"==typeof t.pan?t.pan:defaultParams.pan,t.tempo=t.tempo||defaultParams.tempo,t.timeSign=getTimeSign(t.timeSign||defaultParams.timeSign),t.upbeat=t.upbeat||defaultParams.upbeat,t.quantize=t.quantize||defaultParams.quantize,t.fadeTime=void 0===t.fadeTime?defaultParams.fadeTime:t.fadeTime,t.partLength=t.partLength||defaultParams.partLength,t.changeOnNext=t.changeOnNext||defaultParams.changeOnNext,t.retrig=t.retrig||defaultParams.retrig,t.release=t.release||defaultParams.release,t.externalOffset=t.offset||defaultParams.offset,t.creationTime=t.creationTime||(new Date).getTime(),t.suffix=t.suffix||defaultParams.suffix,t.audioPath=t.audioPath||defaultParams.audioPath,t.loopActive="number"==typeof t.loopActive?t.loopActive:defaultParams.loopActive,t.loopEnd=t.loopEnd||defaultParams.loopEnd,t.activeRange=t.activeRange||defaultParams.activeRange,t.activeRange.min=t.activeRange.min||defaultParams.activeRange.min,t.activeRange.max=t.activeRange.max||defaultParams.activeRange.max,t.activeRange.minVal=void 0===t.activeRange.minVal?defaultParams.activeRange.minVal:t.activeRange.minVal,t.activeRange.maxVal=void 0===t.activeRange.maxVal?defaultParams.activeRange.maxVal:t.activeRange.maxVal}function fade(t,e,a,i){e=e||0,void 0===a&&(a=this.parameters.fadeTime||.25);var r=this.bus.output,n=audioContext.currentTime+e+a,s=n-a,o=r.gain.value;if(this.parameters)var u=this.parameters.volume;t=void 0===t?u||1:t,t=Math.max(t,0),r.gain.cancelScheduledValues(0),r.gain.setValueAtTime(o,s),r.gain.linearRampToValueAtTime(t,n),"function"==typeof i&&setTimeout(i,1e3*(e+a))}function fadeAudioNode(t,e,a,i){t.gain.cancelScheduledValues(0),t.gain.setValueAtTime(e,0),t.gain.linearRampToValueAtTime(a,audioContext.currentTime+i)}function fadeIn(t,e){this.fade(1,t,e)}function fadeOut(t,e){this.fade(0,t,e)}function get(t,e){var a=this.parameters;switch(t){case"bus":return this.bus;case"send":return this.bus.sends[e];case"randomOffset":return 1e3*a[t];default:return a[t]}}function setParams(t){if(t&&t.length)for(let e in t)t.hasOwnProperty(e)&&this.set(t[e].name,t[e].value)}function attributesToObject(t){var e={};if(!t)return e;if(!t.length)return e;for(let a in t)if(t.hasOwnProperty(a)){let i=t[a].name,r=typeFixParam(i,t[a].value);e[i]=r}return e}function typeFixParam(t,e){switch(t){case"volume":e=e.includes("dB")?Math.pow(2,Number(e.split("dB")[0])/3):Number(e);break;case"pan":case"tempo":case"fadeTime":case"loopActive":case"blockRetrig":case"repeat":case"release":case"active":return Number(e);default:return e}}function set(t,e,a){var i=this.parameters||defaultInstance.parameters;switch(t){case"volume":this.setVolume&&this.setVolume(e);break;case"timeSign":e=getTimeSign(e);break;case"loopEnd":e=this.musicalPositionToTime(e);break;case"loopLength":e=this.divisionToTime(String(e)),t="loopEnd";break;case"partLength":"number"==typeof e&&(e/=1e3),this.setPartLength&&this.setPartLength(e);break;case"changeOnNext":"number"==typeof e&&(e/=1e3);break;case"randomOffset":e/=1e3;break;case"repeat":this.setRepeat&&this.setRepeat(e);break;case"upbeat":"number"==typeof e&&(e/=1e3),this.setUpbeat&&this.setUpbeat(e);break;case"active":this.setActive&&this.setActive(e);break;case"fadeTime":e/=1e3;break;case"tags":"string"==typeof e&&(e=e.split(" ")),i=this;break;case"blockRetrig":"string"==typeof e?e=(this.getTime||getTime)(e):e/=1e3;break;case"release":e/=1e3;break;case"tempo":this.setTempo&&this.setTempo(e);break;case"variation":this.setVariation&&this.setVariation(e,a);break;case"solo":case"select-group":this.setSoloGroup&&this.setSoloGroup(e,a);break;case"select-variable":if(this.setSoloGroup){let t="window.";e.substr(0,7)!=t&&(e=t+e),this.setSoloGroup(e,a)}break;case"output":this.bus&&this.bus.setOutput(e,a);break;case"pan":this.bus&&(a=a||1,this.bus.animate("pan",e,a/1e3));break;case"filter":this.bus&&this.bus.setFilter(e);break;case"delay":this.bus&&this.bus.setDelay(e);default:this.bus&&(a=a||1,this.bus.animate(e,a))}return i[t]=e,iMus.debug&&console.log(t,e),{param:t,val:e}}function map(t,e,a,i,r,n,s){s=s||1,e=Math.max(e,a);var o=((e=Math.min(e,i))-a)/(i-a),u=n-r,l=Math.pow(o,s)*u+r;this.set(t,l)}function strToParameters(t){var e={};return e.sectionID=strToParamValue(t,SECTION),e.trackID=strToParamValue(t,TRACK),e.motifID=strToParamValue(t,MOTIF),e.leadinID=strToParamValue(t,LEADIN),e.soundID=strToParamValue(t,SOUND),e.pos=strToParamValue(t,POSITION),e.variantID=strToParamValue(t,VARIANT),e.upbeat=strToParamValue(t,UPBEAT),e.quantize=strToParamValue(t,QUANTIZE),e.length=strToParamValue(t,LENGTH),e}function filesNamesTodata(t){var e={};return t.forEach(function(t){var a,i=strToParameters(t);if(i.sectionID){e.sections=e.sections||[];var r=getObjectFromParam(e.sections,"id",i.sectionID);if(r||(r={},e.sections.push(r)),r.id=i.sectionID,r.tracks=r.tracks||[],i.trackID){var n=getObjectFromParam(r.tracks,"id",i.trackID);n||(n={},r.tracks.push(n));n.id=i.trackID,n.parts=n.parts||[],i.pos=i.pos||(i.variantID?"1":String(n.parts.length+1));var s=getObjectFromParam(n.parts,"pos",i.pos);s||(s={},n.parts.push(s)),s.pos=i.pos,s.url=s.url||[],void 0!==i.upbeat&&(s.upbeat=i.upbeat),s.url.push(t),void 0!==i.length&&(s.length=i.length)}}if(a=r||e,i.motifID){a.motifs||(a.motifs=[]);var o=getObjectFromParam(a.motifs,"id",i.motifID);o||(o={},a.motifs.push(o)),o.id=i.motifID,o.urls=o.urls||[],o.urls.push(t),i.quantize&&(o.quantize=i.quantize)}if(i.leadinID){a.leadin||(a.leadin=[]);var u=getObjectFromParam(a.leadins,"id",i.leadinID);u||(u={},a.leadins.push(u)),u.id=i.motifID,u.urls=o.urls||[],u.urls.push(t),u.quantize="bar"}if(i.soundID){a.sounds||(a.sounds=[]);var l=getObjectFromParam(a.sounds,"id",i.soundID)||{};l.id=l.soundID,l.urls=l.urls||[],l.urls.push(t)}}),e}function getObjectFromParam(t,e,a){return t.find(function(t){return t[e]==a})}}(window.jQuery);