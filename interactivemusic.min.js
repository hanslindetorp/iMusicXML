(function($){function initGUI(e){e||(e=$(body));var r=1;iMus.instances.forEach(function(n){var p=[],l=[];n.sections.forEach(function(f){f.tags.forEach(function(h){!inArray(h,p)&&h.length&&p.push(h)}),f.idName.split(" ").forEach(function(h){!inArray(h,l)&&h.length&&l.push(h)}),f.tracks.forEach(function(h){h.tags.forEach(function(y){!inArray(y,p)&&y.length&&p.push(y)}),h.idName.split(" ").forEach(function(y){!inArray(y,l)&&y.length&&l.push(y)})})}),n.motifs.forEach(function(f){f.tags.forEach(function(h){!inArray(h,p)&&h.length&&p.push(h)}),f.idName.split(" ").forEach(function(h){!inArray(h,l)&&h.length&&l.push(h)})});var u=$("<h2>").html("Music "+r),c=$("<div>",{class:"mixerInstance",id:"mixerInstance-"+r}).append(u),m=$("<div>",{class:"mixerGroups"}),d=$("<div>",{class:"mixerSingles"});c.append(m,d),e.append(c),p.forEach(function(f){var h=new ChannelStrip(n,".",f);m.append(h)}),l.forEach(function(f){var h=new ChannelStrip(n,"#",f);d.append(h)});var g=d.offset().top+d.innerHeight();e.innerHeight(g),r++})}function ChannelStrip(e,r,n){if($label=$("<span>",{class:"label"}).html(r+n),$gui=$("<div>",{class:"channelstrip"}),$slider=$("<div>"),$slider.append($label),$playBtn=$("<button>",{class:"playBtn"}).css({backgroundColor:"white"}).html(">"),$gui.append($slider,$playBtn),$.ui){var p=e.find(r+n).getVolume();p=-1==p?1:p,p=Math.floor(100*p)/100,$slider.slider({value:100*p,min:0,max:200,orientation:"vertical",slide:function(l,u){var c=u.value/100;$(this).find(".ui-slider-handle").html(c),$(this).data("changed",!0),e.find(r+n).setVolume(c)},change:function(){}}).data("selector",r+n).dblclick(function(){$(this).slider("value",100),$(this).find(".ui-slider-handle").html(1),e.find(r+n).setVolume(1)}).find(".ui-slider-handle").html(p)}return $playBtn.click(function(){var l=!$(this).data("state");$(this).data("state",l);var u=l?"green":"white";$(this).css({backgroundColor:u});var c=e.find(r+n);l?c.play():c.stop()}),$gui}function getTimeSign(ts,defTimeSign){if("string"==typeof ts)switch(ts){case"bar":return{nominator:defTimeSign.nominator,denominator:defTimeSign.denominator};break;case"beat":return{nominator:1,denominator:defTimeSign.denominator};break;default:if(tsArr=ts.split("/"),2==tsArr.length)return{nominator:eval(tsArr[0]),denominator:eval(tsArr[1])};}return"object"==typeof ts&&ts.nominator&&ts.denominator?ts:{nominator:4,denominator:4}}function stringIsTimeSign(e){return 2==e.split("/").length}function divisionToTime(e,r,n){if(!e)return 0;r=r||this.parameters.timeSign,n=n||this.getBeatDuration();var e=getTimeSign(e,r);return e.nominator*n*r.denominator/e.denominator}function getMaxUpbeatOffset(e){e=e||this.tracks;var r=0;for(var n in e){var p=e[n];if(p.parts.length){var l=p.parts,u=l[0];r=Math.min(r,u.offset)}}return-r}function getMaxFadeTime(e){e=e||this.tracks;var r=0;return e.forEach(function(n){r=Math.max(r,n.parameters.fadeTime)}),r}function createGainNode(){return"undefined"==typeof audioContext.createGain?audioContext.createGainNode():audioContext.createGain()}function initAudioContextTimer(){if(0==audioContext.currentTime){var r=audioContext.createOscillator();"undefined"==typeof r.start?r.noteOn(0):r.start(0)}}function playSound(e,r,n,p){r=r||0,r=Math.max(audioContext.currentTime,r);var l;if("object"==typeof e.url){var u;if("repeat"==e.parameters.retrig&&e.counter%e.parameters.repeat)iMus.debug&&console.log(e.counter,e.parameters.repeat);else{u=e.parameters.activeVariations?e.parameters.activeVariations.length:"next"==e.parameters.retrig?0:"undefined"==typeof e.rndID||3>e.url.length?e.url.length:e.url.length-1;var c;"number"==typeof e.variation?(c=e.variation,c=Math.max(0,c),c=Math.min(0.9999999999,c)):c=Math.random(),e.rndID=Math.floor(c*u)}e.parameters.activeVariations?(l=e.url[e.parameters.activeVariations[e.rndID]],!l&&(l=e.url[0])):l=e.url[e.rndID]}else l=e.url;var m=e.length,d=l;"object"==typeof d&&(l=d.url,m=d.length||m);var g=Math.floor(1e3*(r-audioContext.currentTime)),f=0;if(buffers[l]){var h=audioContext.createBufferSource();e.playingSources=e.playingSources||[],h.buffer=buffers[l];var y=e.bus.input||iMus.master.input;h.connect(y),e.playing=!0,e.trigging=!0,e.playingSources.push(h),"undefined"==typeof e.active&&(e.active=1),f=g+Math.floor(1e3*h.buffer.duration);var c=Math.random();c<e.active||e.parameters.fadeTime?("undefined"==typeof h.start?h.noteOn(r):h.start(r),e.counter=++e.counter||1,iMus.debug&&console.log(l)):iMus.debug&&console.log("Not playing: "+l+", Math.random = "+c),setTimeout(function(){e.trigging=!1},1e3*(2*timeWindow)),"function"==typeof n&&setTimeout(n,g),"number"==typeof m&&setTimeout(function(){"function"==typeof p&&p(),e.playing=!1},g+1e3*m-1e3*timeWindow),setTimeout(function(){if(e.playing=!1,e.playingSources&&e.playingSources.length){var v=e.playingSources.shift();v.disconnect(0),v=0}h=null,"function"==typeof p&&"undefined"==typeof m&&p()},f)}else iMus.debug&&console.log("Buffer not found: "+l);return d}function loadFile(e,r){r=r||loadComplete;var n=this.addSuffix(e.url);if("string"==typeof n)if(e.url in buffers);else{buffers[e.url]=0;var p=new XMLHttpRequest;p.open("GET",n,!0),p.responseType="arraybuffer",p.onload=function(){audioContext.decodeAudioData(p.response,function(l){l&&(buffers[e.url]=l,r())},function(){console.error("File \""+n+"\" could not be decoded"),buffers[e.url]=-1,r()})},p.onerror=function(){console.error("File \""+n+"\" could not be loaded"),buffers[e.url]=-1,r()},p.send()}}function loadComplete(){for(var e in buffers)if(0==buffers[e])return!1;for(var r in console.log("LoadComplete"),iMus.instances)iMus.instances[r].loadComplete();return!0}function setVolume(e,r){this.bus&&(this.bus.output.gain.value=e,!this.parameters||r||(this.parameters.volume=e))}function getVolume(){return this.bus?this.bus.output.gain.value:-1}function find(e){return new Selection(e,this)}function widthEndingSlash(e){return"/"==e.substring(e.length-1)?e:e+"/"}function urlsToFileNames(e){var r=[];return e.forEach(function(n){if("object"!=typeof n)"string"==typeof n&&r.push(n);else if(n.url){if(n.url instanceof Array){var p=urlsToFileNames(n.url);r=r.concat(p)}else r.push(n.url);}else if(n instanceof Array){var p=urlsToFileNames(n);r=r.concat(p)}}),r}function urlsToTags(e){var r=[],n={},p=urlsToFileNames(e);return p.forEach(function(l){"."==l.substr(-4,1)&&(l=l.substr(0,l.length-4));var u=l.split("_");u.forEach(function(c){n[c]=n[c]||0,n[c]++}),r.push(l)}),Object.keys(n).forEach(function(l){n[l]==p.length&&r.push(l)}),r}function setActiveVariations(e){this.parameters.activeVariations=e}function getPosition(pos,flags){pos=pos||this.musicTime||audioContext.currentTime-this.sectionStart||audioContext.currentTime-self.sectionStart,obj={},obj.bar=1,obj.beat=1,flags=flags||{};var params=this.parameters,beatDuration=this.getBeatDuration(),barDuration=this.getBarDuration();switch(typeof pos){case"string":var delimiter=-1==pos.indexOf(",")?".":",";pos=pos.split(delimiter),pos.length&&(obj.bar=eval(pos[0]));;1<pos.length&&(obj.beat=eval(pos[1]));;obj.time=params.barDuration*(obj.bar-1)+beatDuration*(obj.beat-1);break;case"number":switch(flags.roundTo){case"bar":pos+=barDuration/2;break;case"beat":pos+=beatDuration/2;break;default:}var bar=Math.floor(pos/barDuration);obj.beat=Math.floor(pos/beatDuration)%params.timeSign.nominator+1,obj.bar=bar+1,obj.time=pos;}return obj}function getBeatDuration(e){return e=e||this.parameters,60/e.tempo}function getBarDuration(e){e=e||this.parameters;var r=getBeatDuration(e);return r*e.timeSign.nominator}function setActive(e){var r=this.parameters.activeRange;if(0>e)this.active=e;else if(e>=r.min&&e<=r.max){var n=r.max-r.min,p=e-r.min,l=r.maxVal-r.minVal;this.active=0==n?r.maxVal:r.minVal+p/n*l}else this.active=0}function getTime(e){var r=(this.parameters||defaultParams).timeSign,n=(this.parameters||defaultParams).tempo;if(r||console.log(r),"undefined"==typeof e)e=audioContext.currentTime-(self.sectionStart||defaultInstance.sectionStart);else if("string"==typeof e){var p=e.split("/");1>p.length?p=[0,r.denominator]:2>p.length&&(p[1]=r.denominator);var l=p[0]*r.denominator/p[1];e=60*l/n}return e=e||0,e}function inArray(e,r){"object"!=typeof r&&console.log("no haystack");var n=e.split(" "),p=0;return n.forEach(function(l){var u="*"==l.substr(0,1);u&&(l=l.substr(1)),r.forEach(function(c){u?c.substr(c.length-l.length)==l&&p++:c==l&&p++})}),p>=n.length}function mergeArrays(e,r){return r.forEach(function(n){inArray(n,e)||e.push(n)}),e}function initParameters(e,r){if(r="undefined"==typeof r?{}:JSON.parse(JSON.stringify(r)),"object"==typeof e)for(attr in e=JSON.parse(JSON.stringify(e)),e)r[attr]=e[attr];return this.addDefaultParameters(r),r}function addDefaultParameters(e){e.volume=e.volume||defaultParams.volume,e.tempo=e.tempo||defaultParams.tempo,e.timeSign=getTimeSign(e.timeSign||defaultParams.timeSign),e.upbeat=e.upbeat||defaultParams.upbeat,e.fadeTime=e.fadeTime||defaultParams.fadeTime,e.partLength=e.partLength||defaultParams.partLength,e.externalOffset=e.offset||defaultParams.offset,e.creationTime=e.creationTime||new Date().getTime(),e.suffix=e.suffix||defaultParams.suffix,e.audioPath=e.audioPath||defaultParams.audioPath,e.loopActive="number"==typeof e.loopActive?e.loopActive:defaultParams.loopActive,e.activeRange=e.activeRange||defaultParams.activeRange,e.activeRange.min=e.activeRange.min||defaultParams.activeRange.min,e.activeRange.max=e.activeRange.max||defaultParams.activeRange.max,e.activeRange.minVal="undefined"==typeof e.activeRange.minVal?defaultParams.activeRange.minVal:e.activeRange.minVal,e.activeRange.maxVal="undefined"==typeof e.activeRange.maxVal?defaultParams.activeRange.maxVal:e.activeRange.maxVal}function fade(e,r,n,p){this;r=r||0,"undefined"==typeof n&&(n=this.parameters.fadeTime||0.25);var u=this.bus.output,c=audioContext.currentTime+r+n,m=c-n,d=u.gain.value;if(this.parameters)var g=this.parameters.volume;e="undefined"==typeof e?g||1:e,u.gain.cancelScheduledValues(0),u.gain.setValueAtTime(d,m),u.gain.linearRampToValueAtTime(e,c),"function"==typeof p&&setTimeout(p,1e3*(r+n))}function fadeAudioNode(e,r,n,p){e.gain.cancelScheduledValues(0),e.gain.setValueAtTime(r,0),e.gain.linearRampToValueAtTime(n,audioContext.currentTime+p)}function fadeIn(e,r){this.fade(this.parameters.volume,e,r)}function fadeOut(e,r){this.fade(0,e,r)}function get(e){var r=this.parameters;switch(e){case"bus":return this.bus;break;default:return r[e];}}function set(e,r){var n=this.parameters||defaultInstance.parameters;switch(e){case"volume":this.setVolume&&this.setVolume(r);break;case"timeSign":r=getTimeSign(r);break;case"loopEnd":console.log(r);break;case"partLength":"number"==typeof r&&(r/=1e3),this.setPartLength&&this.setPartLength(r);break;case"repeat":this.setRepeat&&this.setRepeat(r);break;case"upbeat":"number"==typeof r&&(r/=1e3),this.setUpbeat&&this.setUpbeat(r);break;case"active":this.setActive&&this.setActive(r);break;case"fadeTime":r/=1e3;break;case"tags":"string"==typeof r&&(r=r.split(" ")),n=this;break;case"blockRetrig":"string"==typeof r?r=(this.getTime||getTime)(r):r/=1e3;break;case"tempo":this.setTempo&&this.setTempo(r);break;default:}n[e]=r}var defaultSectionName="default";$&&($.fn.iMusGUI=function(){return this.each(function(){initGUI($(this))})});var audioContext,maxChannelCount;if(window.AudioContext=window.AudioContext||window.webkitAudioContext,AudioContext){audioContext=new AudioContext,maxChannelCount=audioContext.destination.maxChannelCount||2,maxChannelCount=Math.min(maxChannelCount,32),console.log("Max audio channels: "+maxChannelCount),audioContext.destination.maxChannelCount?audioContext.destination.channelCount=maxChannelCount:audioContext.destination.webkitMaxChannelCount&&(audioContext.destination.webkitChannelCount=maxChannelCount);var channelCount=audioContext.destination.channelCount||audioContext.destination.webkitChannelCount;console.log("Number of channels: "+channelCount)}else return void alert("Web Audio API not supported. Please use another browser");var buffers={},timeWindow=0.1,Bus=function(e){e=e||{},this.parameters=this.initParameters(e),this.splitter=audioContext.createChannelSplitter(),this.splitter.channelCountMode="explicit",this.splitter.channelInterpretation="discrete";var r=e.destination||audioContext.destination;return this.output=createGainNode(),this.output.gain.value="number"==typeof e.volume?e.volume:1,this.output.connect(r),this.compressor=audioContext.createDynamicsCompressor(),this.compressor.connect(this.output),this.compressor.ratio.value=1,this.panner=audioContext.createPanner(),this.panner.setPosition(0,0,0),this.panner.connect(this.output),this.filter=audioContext.createBiquadFilter(),this.filter.frequency.value=2e4,this.filter.connect(this.output),this.inserts=[],this.inserts.push(this.filter),this.input=createGainNode(),this.input.connect(this.filter),this.sends={},this.channelMerger=e.channelMerger||self.channelMerger,this};Bus.prototype.initParameters=initParameters,Bus.prototype.addDefaultParameters=addDefaultParameters,Bus.prototype.getBeatDuration=getBeatDuration,Bus.prototype.getBarDuration=getBarDuration,Bus.prototype.getTime=getTime,Bus.prototype.setOutput=function(e,r){if(this.output.disconnect(0),this.splitter.disconnect(0),this.output.connect(this.splitter,0,0),"number"==typeof e&&(e=[e]),r){"number"==typeof r&&(r=[r]);for(var l,n=Math.max(e.length,r.length),p=0;p<n;p++){l=e[p%e.length],l=Math.min(l,maxChannelCount-1);var u=r[p%r.length];u=Math.min(u,maxChannelCount-1),this.splitter.connect(this.channelMerger,l,u)}}else for(var c,p=0;p<e.length;p++)c=Math.min(e[p],maxChannelCount-1),this.splitter.connect(this.channelMerger,0,c)},Bus.prototype.volume=function(e){return"undefined"==typeof e?this.output.gain.value:void(this.output.gain.value=e)},Bus.prototype.setVolume=Bus.prototype.volume,Bus.prototype.compression=function(e){if("undefined"==typeof e)return this.compressor;if(!1==e);else for(var r in e)this.compressor[r].value=e[r]},Bus.prototype.addPingPongDelay=function(e){e=e||{};var n,r=e.feedBack||10;n="string"==typeof e.delay?this.getTime(e.delay):e.delay?e.delay/1e3:0.25;var u,c,p=e.outputs||[0,1],l=e.volume||0.5;this.pingPongDelay=createGainNode(),this.output.connect(this.pingPongDelay,0,0);for(var m=1;m<=r;m++){u=audioContext.createDelay(r*n),this.pingPongDelay.connect(u,0),u.delayTime.value=n*m,c=createGainNode(),c.gain.value=l,l*=0.5,c.channelCount=1,c.channelCountMode="explicit",c.channelInterpretation="discrete",u.connect(c,0,0);var d=Math.floor(Math.random()*p.length-1),g=p.splice(d,1)[0];p.push(g),c.connect(this.channelMerger,0,g)}},Bus.prototype.addSerialDelay=function(e){e=e||{};var n,r=e.feedBack||10;n="string"==typeof e.delay?this.getTime(e.delay):e.delay?e.delay/1e3:0.25;var u,c,p=e.outputs||[0,1],l=e.volume||0.5;this.pingPongDelay=createGainNode(),this.output.connect(this.pingPongDelay,0,0);for(var m=1;m<=r;m++){u=audioContext.createDelay(r*n),this.pingPongDelay.connect(u,0),u.delayTime.value=n*m,c=createGainNode(),c.gain.value=l,l*=0.5,c.channelCount=1,c.channelCountMode="explicit",c.channelInterpretation="discrete",u.connect(c,0,0);var d=p[m%p.length];d=Math.min(d,maxChannelCount-1),c.connect(this.channelMerger,0,d)}},Bus.prototype.addReverb=function(e){if(e&&e.url){"undefined"==typeof e.value&&(e.value=1);var r=this.sends[e.url];r||(r=createGainNode(),this.sends[e.url]=r),r.gain.value=e.value,this.output.connect(r),e.src=r;defaultInstance.addReverb(e)}},Bus.prototype.insertEffect=function(){var n=audioContext.createBiquadFilter(),p=this.inserts[0];p.disconnect(0),this.inserts.shift(n)},Bus.prototype.setPosition=function(e,r,n){this.panner.active||(this.filter.disconnect(0),this.filter.connect(this.panner),this.panner.active=!0),this.panner.setPosition(e,r,n)},Bus.prototype.addAnalyser=function(e,r,n){r=r||100;var p=audioContext.createAnalyser();this.input.connect(p),p.fftSize=n||2048;var l=p.frequencyBinCount,u=new Uint8Array(l);setInterval(function(){p.getByteTimeDomainData(u),e(u,l)},r)};var Sequence=function(e){this.iMusInstance=e.iMusInstance,this.objects=e.objects||[],this.firstOffset=e.firstOffset||0,this.loopEnd=e.loopEnd,this.timerIDs=[]};Sequence.prototype.maxUpbeatOffset=function(){},Sequence.prototype.play=function(){var e=this;this.timerIDs.push(setTimeout(function(){},1e3))};var iMus=function(o,b){function getNextLegalBreak(e){var n=this.parameters.legalBreakPoints||[{pos:"2.1"}],p=this.musicalPositionToTime(this.get("loopEnd")||"2.1");e=e||audioContext.currentTime;var l=e-self.sectionStart,c=Math.floor(l/p),m=n.find(function(g){var f;switch(typeof g){case"object":f=this.musicalPositionToTime(g.pos);break;case"number":f=g;}return f>l%p},this);m||(m=n[n.length-1]),console.log(c,p,m);var d;return d={},d.time=self.sectionStart+c*p+this.musicalPositionToTime(m.pos),d.fadeTime=m.fadeTime||this.parameters.fadeTime||0.01,d.timeLeft=d.time-audioContext.currentTime,0>d.timeLeft&&(console.log(d),d.timeLeft=0),d}function posStringToObject(pos){if(obj={},obj.bar=1,obj.beat=1,"string"==typeof pos){var delimiter=-1==pos.indexOf(",")?".":",";pos=pos.split(delimiter),pos.length&&(obj.bar=eval(pos[0])),1<pos.length&&(obj.beat=eval(pos[1]))}return obj}function musicalPositionToTime(e){var r=0;switch(typeof e){case"string":var n=posStringToObject(e);r=this.getBarDuration()*(n.bar-1)+this.getBeatDuration()*(n.beat-1);break;case"number":r=e;}return r}function createParts(e,r,n){for(var c,p=[],l=0,u=0;u<e.length;u++)c=new Part(e[u],r,n,l),p.push(c),l=c.pos+c.length;return p}var self=this;if(o=o||{},"string"==typeof o||Array.isArray(o))return new Selection(o,b);o.onLoadComplete=o.onLoadComplete||b,this.loadFile=loadFile,this.init=function(){initAudioContextTimer(this)},this.getBus=function(e){switch(e){case"sfx":return this.sfxBus;break;case"motif":return this.motifBus;break;default:if(e<=self.busses.length)return self.busses[e-1];this.parameters.destination=this.master.input,this.parameters.channelMerger=this.channelMerger;var r=new Bus(this.parameters);return self.busses[e]=r,r;}},this.addSection=function(){var e;if(arguments.length){var r=Array.prototype.slice.call(arguments,0);"object"!=typeof r[0]||r[0].url||(e=r.shift())}e=e||{},e.urls=e.urls||r,"undefined"==typeof e.upbeat&&(e.upbeat=self.upbeat),e.index=self.sections.length;var n=new Section(e);return self.sections.push(n),n},this.stop=function(){clearInterval(self.queueID),self.queueID=null,self.playing=!1},self.loadComplete=function(){switch(typeof self.parameters.onLoadComplete){case"function":self.parameters.onLoadComplete();break;case"string":iMus.play(self.parameters.onLoadComplete);}},params=o||{},this.parameters=this.initParameters(o),self.volume=params.volume||1,self.parameters.tempo=params.tempo||120,self.parameters.timeSign=params.timeSign||"4/4",self.parameters.timeSign=getTimeSign(self.parameters.timeSign),self.upbeat="string"==typeof params.upbeat?this.getTime(params.upbeat):params.upbeat,self.upbeat=self.upbeat||0,self.externalOffset=params.offset,self.creationTime=new Date().getTime(),self.parameters=this.initParameters(params),self.parameters.onLoadComplete=params.onLoadComplete,self.parameters.destination=iMus.master.output,self.parameters.volume=self.volume,self.master=new Bus(this.parameters),self.bus=self.master,self.master.output.channelCount=maxChannelCount,self.channelMerger=audioContext.createChannelMerger(Math.max(32,maxChannelCount)),self.channelMerger.channelCount=1,self.channelMerger.channelCountMode="explicit",self.channelMerger.channelInterpretation="discrete",self.channelMerger.connect(self.master.output),self.sendEffects={};for(var snd,i=0;i<maxChannelCount;i++)snd=audioContext.createBufferSource(),snd.connect(self.channelMerger,0,i);self.transitionParts=[],self.sections=[],self.actions=[],self.currentSection,self.currentTransition,self.playing=!1,self.sectionStart=0,self.musicalStart=0,self.motifs=[],self.busses=[],self.intervalIDs=[],this.parameters.destination=self.master.input,this.parameters.channelMerger=self.channelMerger,self.sfxBus=new Bus(this.parameters),self.motifBus=new Bus(this.parameters),iMus.instances.push(this),this.checkQueue=function(){if(self.playing){var e=audioContext.currentTime,r=e-self.sectionStart;if(self.musicTime=r,self.currentSection)for(trackID in tracks=self.currentSection.tracks,tracks){var n=tracks[trackID],p=!1,l=n.musicalPositionToTime(n.parameters.loopEnd),u=Math.floor(r/l),m=(r+1e3*l)%l;if(u!=n.loopID){n.active||n.parameters.fadeTime;var d=Math.random();n.playing=n.loopActive>d,n.loopID=u,p=!0,n.eventHandler.execute("loopEnd",1e3*l)}if(0<n.active&&n.playing&&!n.parameters.fadeTime||n.parameters.fadeTime)for(partID in n.parts){var g=n.parts[partID];if(!(g.playing||g.trigging)){g.active=n.active,g.parameters.fadeTime=n.parameters.fadeTime;var f=(g.pos+g.offset+l)%l,h=f+l,v=m<=h&&m+timeWindow>h,T=n.parameters.fadeTime&&!n.playing;if((m<=f&&m+timeWindow>f||v||T)&&-1<=u){var S=self.sectionStart+u*l+f+(v?l:0);if(n.parameters.fadeTime)for(;S<e;)S+=l;if(S<e);else if(n.playingParts.push(g),g.lastTriggedTime!=S){g.lastTriggedTime=S;var E=playSound(g,S);switch(n.parameters.retrig){case"next":case"shuffle":case"other":case"repeat":if(!g.parameters.activeVariations){var P=g.url.indexOf(E);E=g.url.splice(P,1)[0],g.url.push(E)}else if(g.counter%g.parameters.repeat);else{var D=g.parameters.activeVariations.splice(g.rndID,1)[0];g.parameters.activeVariations.push(D)}}}}else;}}}}};var Section=function(e){this.id=e.index,this.volume=e.volume||1,this.upbeat="undefined"==typeof e.upbeat?self.upbeat:self.getTime(e.upbeat),this.tracks=[],this.transitions=[],this.leadIns=[],this.idName=e.id||"",this.tags=e.tags||e.class||[],"string"==typeof this.tags&&(this.tags=this.tags.split(" ")),this.parameters=this.initParameters(e,self.parameters),e.loopEnd=defaultParams.loopEnd||e.end||e.loopEnd||0,this.parameters.loopEnd=this.getPosition(e.loopEnd).time,this.type="section",this.addStem=function(n){if(n instanceof Array)n[0].url||"string"==typeof n[0]||(e=n.shift());else{var p=Array.prototype.slice.call(arguments,0);"object"!=typeof p[0]||p[0].url||(e=p.shift()),n=p[0]instanceof Array?p[0]:p}var l="object"==typeof e?e:{},u=this.tracks.length;l.loopActive="number"==typeof l.loopActive?l.loopActive:1,l.destination=l.destination||self.master.input,l.channelMerger=l.channelMerger||self.channelMerger,l.timeSign=l.timeSign||this.parameters.timeSign,l.tempo=l.tempo||this.parameters.tempo,l.upbeat=l.upbeat||this.parameters.upbeat,l.audioPath=l.audioPath||this.parameters.audioPath,l.partLength=l.partLength||this.parameters.partLength,l.loopEnd=l.loopEnd||this.parameters.loopEnd,l.volume="number"==typeof l.volume?l.volume:this.parameters.volume;var c;c=new Bus(l),self.busses.push(c);var m=this.createParts(n,l,c);l.index=u,l.parts=m,l.bus=c;var d=new Track(l,this);return l.fadeTime&&d.setVolume(0,!0),this.tracks.push(d),d},e&&e.urls&&e.urls.length&&this.addStem(e.urls),this.addTransition=function(){var p=Array.prototype.slice.call(arguments,0),l=p.shift(),u=p[0];if(u instanceof Object)if(u.url);else var c=p.shift();c=c||{},"undefined"==typeof c.upbeat&&(c.upbeat=self.upbeat),c.urls=p,c.index=self.sections.length,this.transitions[l.id]=new Section(c)};var r=!1;this.setOffset=function(n){self.sectionStart;if("number"==typeof n)self.sectionStart=audioContext.currentTime-n/1e3;else if("undefined"!=typeof self.externalOffset){var l=new Date().getTime(),u=(l-self.creationTime+self.externalOffset)/1e3;self.sectionStart=audioContext.currentTime-u}else{var c=getMaxUpbeatOffset(this.tracks);self.sectionStart=audioContext.currentTime+c+timeWindow}return self.sectionStart},this.stop=function(){r=!1,self.queueID&&clearInterval(self.queueID),self.queueID=null,self.playing=!1,this.tracks.forEach(function(p){p.parts.forEach(function(l){l.counter=0})}),self.playing&&self.currentSection==this&&(this.postSection?this.postSection.play(1):self.stop())},this.queue=function(){this.play(1)},this.replay=function(){this.stop(),this.play()},this.play=function(n,p){if(!(r||self.currentSection==this&&self.playing)){self.playing||(initAudioContextTimer(self),!self.queueID&&(this.tracks.forEach(function(P){P.nextTime=0}),self.queueID=setInterval(self.checkQueue,50),self.checkQueue()));var l=this.getBarDuration(),u=this;if(self.currentSection&&self.playing){var c=self.currentSection.getNextLegalBreak().time,m=c-audioContext.currentTime,d=this.getMaxUpbeatOffset(),g=self.currentSection.getMaxUpbeatOffset(),f=this.getMaxFadeTime(),h=self.currentSection.getMaxFadeTime(),y=this.getMaxLeadInUpbeatOffset(),v=this.getMinLeadInUpbeatOffset(),T=Math.max(d,g,f,h),S=Math.min(m-y,m-v);setTimeout(function(){v<m&&!p&&u.leadIns.forEach(function(P){P.play()})},Math.max(1,1e3*(S-timeWindow))),self.currentSection.finishPlaying(m),self.sectionStart=c,this.tracks.forEach(function(P){P.parameters.fadeTime&&(P.parts.forEach(function(){}),0<P.active&&P.fadeIn())})}else{var c=this.setOffset();self.playing||(self.musicalStart=c)}self.playing=!0;var E;if(0<n)self.sectionStart=c,this.schedule(n),self.sectionStart+=this.length*n;else{for(var x in E=E||0,this.tracks){var D=this.tracks[x];D.currentPartID=E,D.nextTime=c}self.currentSection=this}r=!0,setTimeout(function(){r=!1},200)}}};Section.prototype.stopAllSounds=function(){this.stop(),this.tracks.forEach(function(e){e.stopAllSounds()})},Section.prototype.addLoopTrack=function(e){"string"==typeof e&&(e=[e]);var r=mergeArrays(urlsToTags(e),this.tags);return this.addStem({tags:r},e)},Section.prototype.addStingerTrack=function(e){var r=urlsToTags(e);return self.addMotif({tags:r},e)},Section.prototype.addTrackGroup=function(e){var r=new Selection(e,this.tracks);if(r.group(),r.objects.length){var n=r.objects[0];n.play()}},Section.prototype.schedule=function(e){var r=this.parameters.loopEnd*e;for(trackID in this.tracks)for(var u,n=self.sectionStart,p=this.tracks[trackID],l=0;n<r;l++)for(partID in u=l*p.parameters.loopEnd,p.parts){var c=p.parts[partID];c.active=p.active;var m=c.pos+c.offset,d=self.sectionStart+u+m;playSound(c,d)}},Section.prototype.getNextLegalBreak=getNextLegalBreak,Section.prototype.finishPlaying=function(e){this.tracks.forEach(function(r){r.finishPlaying(e)})},Section.prototype.addLeadIn=function(e,r){var n=self.addLeadIn(e,r);this.leadIns.push(n)},Section.prototype.getMaxLeadInUpbeatOffset=function(){var e=0;return this.leadIns.forEach(function(r){e=Math.max(e,r.getMaxUpbeatOffset())}),e},Section.prototype.getMinLeadInUpbeatOffset=function(){var e=this.getBarDuration();return this.leadIns.forEach(function(r){e=Math.min(e,r.getMinUpbeatOffset())}),e},Section.prototype.setTempo=function(e){this.parameters.tempo=e,this.tracks.forEach(function(r){r.parameters.tempo=e,r.parts.forEach(function(n){n.parameters.tempo=e})})},Section.prototype.initParameters=initParameters,Section.prototype.addDefaultParameters=addDefaultParameters,Section.prototype.getBeatDuration=getBeatDuration,Section.prototype.getBarDuration=getBarDuration,Section.prototype.getPosition=getPosition,Section.prototype.createParts=createParts,Section.prototype.getTime=getTime,Section.prototype.set=set,Section.prototype.get=get,Section.prototype.getMaxUpbeatOffset=getMaxUpbeatOffset,Section.prototype.getMaxFadeTime=getMaxFadeTime,Section.prototype.musicalPositionToTime=musicalPositionToTime;var Track=function(e,r){params=e||{},this.id=params.index,this.parts=params.parts,this.nextTime=0,this.currentPartID=0,this.tags=params.tags||params.class||"","string"==typeof this.tags&&(this.tags=this.tags.split(" ")),this.idName=params.id||"",this.playingParts=[],this.groups=[],this.section=r,this.type="track",this.liveValues={},this.bus=e.bus||self.getBus(this.id),this.volume="number"==typeof e.volume?e.volume:1,this.bus.output.gain.value=this.volume,this.loopID,this.loopActive="number"==typeof e.loopActive?e.loopActive:1,this.playing=!1,this.active="boolean"==typeof params.active?params.active?1:0:"number"==typeof params.active?1<params.active?1:-1>params.active?-1:params.active:1,params.fadeTime&&(params.fadeTime/=1e3),this.parameters=this.initParameters(params,r.parameters);var n=self.getBeatDuration(),p=self.getBarDuration();if(this.parameters.loopEnd=params.loopEnd||r.parameters.loopEnd||self.parameters.loopEnd||defaultParams.loopEnd,"string"==typeof params.loopEnd)this.parameters.loopEnd=this.musicalPositionToTime(e.loopEnd);else if(this.parts.length){var l=this.parts[this.parts.length-1];l.length=l.length||p,this.parameters.loopEnd=l.pos+l.length}else this.parameters.loopEnd=p;this.eventHandler=new EventHandler};Track.prototype.play=function(){initAudioContextTimer(self);var e=this;if(this.groups.forEach(function(p){p.stop({omit:e})}),!(0<this.active))if(this.active=0==this.active?1:-this.active,!self.playing)this.section.play();else if(this.parameters.fadeTime){var r;r=this.getNextLegalBreak(),r||(r=this.section.getNextLegalBreak(),r.fadeTime=this.parameters.fadeTime);var n=r.time-audioContext.currentTime;this.fade(this.parameters.volume,n,r.fadeTime)}},Track.prototype.stop=function(){if(!(0>=this.active)&&(this.active=-this.active,this.parameters.fadeTime))if(self.playing){var e=this.getNextLegalBreak();this.fade(0,e.timeLeft,e.fadeTime)}else this.fade(0,0,0)},Track.prototype.stopAllSounds=function(){this.finishPlaying(0)},Track.prototype.finishPlaying=function(e){var r=this.parameters.fadeTime;this.playing=!1;var n=this,p=function(){n.parts.forEach(function(l){if(l.playingSources)for(;l.playingSources.length;){var u=l.playingSources.shift();u.disconnect(0),u=0}})};r?this.fade(0,e,r,p):p()},Track.prototype.setVariation=function(e){this.parts.forEach(function(r){r.variation=e})},Track.prototype.setPartLength=function(e){e=this.divisionToTime(e),this.parts.forEach(function(r){r.length=e})},Track.prototype.setUpbeat=function(e){e=this.divisionToTime(e),this.parts.forEach(function(r){r.offset=-e})},Track.prototype.setRepeat=function(e){this.parts.forEach(function(r){r.parameters.repeat=e,r.counter=0})},Track.prototype.update=function(e){this.parts=this.createParts(e,this.parameters,this.bus)},Track.prototype.getNextLegalBreak=getNextLegalBreak,Track.prototype.initParameters=initParameters,Track.prototype.addDefaultParameters=addDefaultParameters,Track.prototype.getBeatDuration=getBeatDuration,Track.prototype.getBarDuration=getBarDuration,Track.prototype.getPosition=getPosition,Track.prototype.setActive=setActive,Track.prototype.createParts=createParts,Track.prototype.getTime=getTime,Track.prototype.setVolume=setVolume,Track.prototype.getVolume=getVolume,Track.prototype.fade=fade,Track.prototype.fadeIn=fadeIn,Track.prototype.fadeOut=fadeOut,Track.prototype.musicalPositionToTime=musicalPositionToTime,Track.prototype.set=set,Track.prototype.divisionToTime=divisionToTime,Track.prototype.get=get,Track.prototype.setActiveVariations=function(e){this.parameters.activeVariations=e,this.parts.forEach(function(r){r.parameters.activeVariations=e})};var Part=function(e,r,n,p){e instanceof Array?e={url:e}:"string"==typeof e&&(e={url:e}),e=e||{},r=r||{},this.parameters=this.initParameters(r);var l=getBeatDuration(r),u=getBarDuration(r);"string"==typeof r.timeSign&&(r.timeSign=getTimeSign(r.timeSign));r.timeSign||self.parameters.timeSign;upbeat=e.upbeat||r.upbeat||self.parameters.upbeat||r.upbeat,"string"==typeof upbeat?(upbeat=getTimeSign(upbeat),upbeat=upbeat.nominator*l*self.parameters.timeSign.denominator/upbeat.denominator):"number"==typeof upbeat&&(upbeat/=1e3),this.offset=-upbeat||0,"string"==typeof e.pos&&(p=this.musicalPositionToTime(e.pos)),this.pos=p;var m;"number"==typeof e.length?m=e.length:(m=e.length||r.partLength,m=divisionToTime(m,r.timeSign,l)),this.length=m;var d="string"==typeof e.url?[e.url]:e.url,g=[];for(var f in d.forEach(function(h){g.push(h)}),this.url=g,this.url)"string"==typeof this.url[f]&&this.url[f].length&&(this.url[f]=widthEndingSlash(r.audioPath)+this.url[f],self.loadFile({url:this.url[f]}),console.log(this.url[f]+": pos: "+this.pos+"; offset: "+this.offset+"; length: "+this.length));this.id=e.index,this.parameters.destination=n.input,this.parameters.channelMerger=self.channelMerger,this.bus=new Bus(this.parameters)};Part.prototype.fade=fade,Part.prototype.initParameters=initParameters,Part.prototype.addDefaultParameters=addDefaultParameters,Part.prototype.getBeatDuration=getBeatDuration,Part.prototype.getBarDuration=getBarDuration,Part.prototype.getPosition=getPosition,Part.prototype.setActive=setActive,Part.prototype.musicalPositionToTime=musicalPositionToTime;var Motif=function(e){this.id=self.motifs.length,this.type="motif";var r=this,n=self.getBeatDuration();this.quantize=getTimeSign(e.quantize||defaultInstance.parameters.quantize||defaultParams.quantize),this.volume=e.volume||1,this.parameters=this.initParameters(e,self.parameters),this.loop=e.loop||0,this.loopCnt=0,this.idName=e.id||"",this.tags=e.tags||params.tags||params.class||[],"string"==typeof this.tags&&(this.tags=this.tags.split(" ")),this.parameters.destination=self.motifBus.input,this.parameters.channelMerger=self.channelMerger,this.bus=new Bus(this.parameters),this.active="number"==typeof e.active?e.active:1,this.sounds=[],this.offset=-self.getTime(this.parameters.upbeat);var p,l;for(var u in e.urls){if(l=e.urls[u],"string"==typeof l)p={},p.url=widthEndingSlash(self.parameters.audioPath)+l,p.offset=this.offset||0;else if("object"==typeof l){if(p=l,p.url=widthEndingSlash(self.parameters.audioPath)+p.url,p.length){var c=getTimeSign(p.length);p.length=c.nominator*n*self.parameters.timeSign.denominator/c.denominator}p.offset=-self.getTime(p.upbeat||this.parameters.upbeat),p.offset=p.offset||0}else console.error("Motif url is not correct: "+l);self.loadFile(p),this.sounds.push(p)}r.triggedRecently=!1,this.play=function(){var m=this.parameters.blockRetrig||0;if(arguments.length){var d=Array.prototype.slice.call(arguments,0);if("number"==typeof d[0]&&(m=d.shift()),"string"==typeof d[0]){var g=d.shift();"loop"===g?this.loop=-1:void 0}"function"==typeof d[0]&&(this.callBackOnFinish=d.shift())}if(r.triggedRecently)return void console.log("trigged recently");r.playing=!0;var f=self.currentSection.getBeatDuration(),h=this.quantize.nominator*f*self.currentSection.parameters.timeSign.denominator/this.quantize.denominator,y=self.currentSection.getTime(),v=Math.ceil(y/h)*h+self.sectionStart,T=y%h;this.sounds.sort(function(B,O){var L=h+B.offset-T;L=0>L?L+h:L;var C=h+O.offset-T;return C=0>C?C+h:C,L-C});for(var D,E=[],x=0;x<this.sounds.length;x++)D=this.sounds[x],E.length?D.offset==E[0].offset&&E.push(D):E.push(D);for(var P in this.url=[],E){var I=E[P];this.url.push(I)}for(var k=v+I.offset;k<audioContext.currentTime;)k+=h;var M=this,j=playSound(this,k,this.callBackOnStart,function(){switch(r.loop){case-1:r.playing&&r.play();break;case 0:r.playing=!1;break;default:r.loopCnt++,r.loopCnt<=r.loop?r.play():(r.playing=!1,r.loopCnt=0);}M.callBackOnFinish&&M.callBackOnFinish()});switch(this.parameters.retrig){case"next":case"shuffle":case"repeat":var x=this.sounds.indexOf(j);j=this.sounds.splice(x,1)[0],this.sounds.push(j);}return m&&(r.triggedRecently=!0,setTimeout(function(){r.triggedRecently=!1},1e3*m)),1e3*(h-T)},this.stop=function(){r.playing=!1,r.triggedRecently=!1;var m=this.bus.input;fadeAudioNode(m,1,0,0.01),r.playingSources&&setTimeout(function(){r.playingSources.forEach(function(d){d.disconnect(0)}),fadeAudioNode(m,0,1,0)},20)}};this.addMotif=function(){var e={};if(arguments.length){var r=Array.prototype.slice.call(arguments,0);r[0]instanceof Array&&(r=r[0]),"object"!=typeof r[0]||r[0].url||(e=r.shift()),e.urls=Array.isArray(r[0])?r[0]:r}else return-1;var n=new Motif(e);return self.motifs.push(n),n},Motif.prototype.getMaxUpbeatOffset=function(){var e=0;return this.sounds.forEach(function(r){e=Math.min(e,r.offset)}),-e},Motif.prototype.getMinUpbeatOffset=function(){var e=-this.getBarDuration();return this.sounds.forEach(function(r){e=Math.max(e,r.offset)}),-e},this.addLeadIn=this.addMotif,Motif.prototype.initParameters=initParameters,Motif.prototype.addDefaultParameters=addDefaultParameters,Motif.prototype.getBeatDuration=getBeatDuration,Motif.prototype.getBarDuration=getBarDuration,Motif.prototype.getPosition=getPosition,Motif.prototype.setActive=setActive,Motif.prototype.setVolume=setVolume,Motif.prototype.getVolume=getVolume,Motif.prototype.set=set,Motif.prototype.fade=fade,Motif.prototype.fadeIn=fadeIn,Motif.prototype.fadeOut=fadeOut,Motif.prototype.setActiveVariations=setActiveVariations,Motif.prototype.get=get;var SFX=function(){for(var e in this.url=Array.prototype.slice.call(arguments,0),this.bus=new Bus({destination:self.sfxBus.input,channelMerger:self.channelMerger}),this.url)this.url[e]=widthEndingSlash(self.parameters.audioPath)+this.url[e],self.loadFile({url:this.url[e]});var r=!1;return this.play=function(){var n=this.parameters.blockRetrig;if(arguments.length){var p=Array.prototype.slice.call(arguments,0);if("number"==typeof p[0]&&(n=p.shift()),"function"==typeof p[0])var l=p.shift()}r||(n=n||500,playSound(this,audioContext.currentTime,null,l),r=!0,setTimeout(function(){r=!1},n))},this};SFX.prototype.setVolume=setVolume,SFX.prototype.getVolume=getVolume,SFX.prototype.get=get,this.addSFX=function(){function e(r){return SFX.apply(this,r)}return e.prototype=SFX.prototype,function(){return new e(arguments)}}()};iMus.prototype.initParameters=initParameters,iMus.prototype.addDefaultParameters=addDefaultParameters,iMus.prototype.getBeatDuration=getBeatDuration,iMus.prototype.getBarDuration=getBarDuration,iMus.prototype.getTime=getTime,iMus.prototype.addSuffix=function(e){var r=e.substr(-4);switch(r){case".wav":case".mp3":case".ogg":return e;break;default:return e+"."+this.parameters.suffix;}},iMus.prototype.getPosition=getPosition,iMus.prototype.divisionToTime=divisionToTime,iMus.prototype.fade=fade,iMus.prototype.fadeOut=fadeOut,iMus.prototype.fadeIn=fadeIn,iMus.prototype.setOffset=function(e){var r;for(var n in this.sections){var p=this.sections[n];r=p.setOffset(e)}return r},iMus.prototype.find=find,iMus.prototype.play=function(){this.sections.length&&this.sections[0].play()},iMus.prototype.call=function(e,r){var n=new Selection(e,this);n.play(r)},iMus.prototype.addAction=function(e,r){this.actions.push(new Action(e,r))},iMus.prototype.addReverb=function(e){if(e&&e.url&&e.src){var r=widthEndingSlash(this.parameters.audioPath)+e.url,n=this.sendEffects[r],p=this;n||(n=audioContext.createConvolver(),this.sendEffects[r]=n,this.loadFile({url:r},function(){var l=buffers[r],u=audioContext.createBufferSource();u.buffer=l,n.buffer=l,n.loop=!0,n.normalize=!0,n.connect(e.output||p.master.output)})),e.src.connect(n)}},iMus.addLFO=function(e,r,n,p,l){if("string"==typeof e){var u;if("undefined"==typeof l){var c=this instanceof Section||this instanceof Track||this instanceof Motif||this instanceof Sequence;c?u=this.bus:this instanceof Bus&&(u=this),u&&("filter"===e?l=u.filter.detune:"volume"===e?l=u.output.gain:void 0)}else l=l;if("object"==typeof l){r=r||1,n=n||1,p=p||0;var m=audioContext.createOscillator(),d=createGain();d.gain.value=n,m.frequency.value=r,m.connect(d),d.connect(l),m.start()}}},iMus.prototype.setTempo=function(e){this.sections.forEach(function(r){r.setTempo(e)})},iMus.setTempo=function(e){this.instances.forEach(function(r){r.setTempo(e)})},iMus.prototype.on=function(r,n,p,l){if(n){p=p||0,p/=1e3,l=l||-1;var c,u=this,d=1;switch(typeof r){case"string":if(stringIsTimeSign(r)){c=this.divisionToTime(r)}break;case"number":c=r/1e3;break;default:return;}var f=function(){var y=u.musicalStart+c*d+p,v=y-audioContext.currentTime;d++,setTimeout(function(){n(),(d<=l||-1==l)&&f()},1e3*v)},h=function(){u.playing?f():setTimeout(h,100)};return h(),c}};var Action=function(e,r){return this.idName=e,this.tags=e.split(" "),this.play=r,this},Selection=function(e,r){var n=[];switch(this.objects=[],typeof e){case"string":break;case"object":e=e.join(" ");break;default:return this;}if(!e.length)return this;var p;switch(typeof e){case"string":this.selector=e,e=e.split(" ").shift();var l=e.substr(0,1);"#"===l?(p="id",e=e.substr(1)):"."===l?(p="class",e=e.substr(1)):(p="class",e=this.selector);break;default:return this;}var u;u=r instanceof iMus?[r]:iMus.instances,r instanceof Selection?n=r.objects:r instanceof Array?n=r:u.forEach(function(m){m.sections.forEach(function(d){n.push(d),d.tracks.forEach(function(g){n.push(g)})}),m.motifs.forEach(function(d){n.push(d)}),m.actions.forEach(function(d){n.push(d)})});var c=[];return n.some(function(m){switch(p){case"id":m.idName==e&&c.push(m);break;case"class":var d=inArray(e,m.tags);if(d){if("section"==m.type)return c=[m],!0;c.push(m)}break;case"objectType":"track"===e||"stem"===e?m instanceof Track&&c.push(m):"motif"===e?m instanceof Motif&&c.push(m):void 0;}}),this.objects=c,this};Selection.prototype.createDefaultSectionIfNeeded=function(){if(!this.objects.length){var e=defaultInstance.addSection({tags:this.selector});defaultInstance.currentSection||(defaultInstance.currentSection=e),this.objects.push(e)}},Selection.prototype.addLoopTrack=function(e){var r;return this.createDefaultSectionIfNeeded(),e||(e=[]),this.objects.forEach(function(n){n.addLoopTrack&&(r=n.addLoopTrack(e))}),this.objects=[r],this},Selection.prototype.addLFO=function(e,r,n,p,l){return this.objects.forEach(function(u){u.addLFO&&u.addLFO(e,r,n,p,l)}),this},Selection.prototype.addDelay=function(e){return this.objects.forEach(function(r){r.bus&&r.bus.addSerialDelay(e)}),this},Selection.prototype.addReverb=function(e){return this.objects.forEach(function(r){r.bus&&r.bus.addReverb(e)}),this},Selection.prototype.addMotif=function(e){"string"==typeof e&&(e=[e]),this.createDefaultSectionIfNeeded();var r=urlsToTags(e);this.objects.length&&(r=mergeArrays(r,this.objects[0].tags));var n=this.objects.find(function(l){return"function"==typeof l.addMotif})||defaultInstance,p=n.addMotif({tags:r},e);return this.objects=[p],this},Selection.prototype.addLeadIn=Selection.prototype.addMotif,Selection.prototype.solo=function(e){return this.stop(),this.find(e).play(),this},Selection.prototype.play=function(e,r,n){return this.objects.forEach(function(p){return p.play?p.play(e,r,n):void 0}),this},Selection.prototype.trig=Selection.prototype.play,Selection.prototype.replay=function(){return this.objects.forEach(function(e){return e.replay?e.replay():void 0}),this},Selection.prototype.stop=function(e){return e=e||{},this.objects.forEach(function(r){return r.stop?r==e.omit?void 0:r.stop():void 0}),this},Selection.prototype.stopAllSounds=function(){return this.objects.forEach(function(e){e.stopAllSounds&&e.stopAllSounds()}),this},Selection.prototype.isPlaying=function(){var e=!1;return this.objects.forEach(function(r){var n=r.isPlaying?r.isPlaying():r.playing;e=e||n}),e},Selection.prototype.setActive=function(e){return this.objects.forEach(function(r){return r.setActive?r.setActive(e):void 0}),this},Selection.prototype.setOutput=function(e,r){return this.objects.forEach(function(n){return n.bus?n.bus.setOutput(e,r):void 0}),this},Selection.prototype.setVolume=function(e,r){return this.objects.forEach(function(n){return n.setVolume?n.setVolume(e,r):void 0}),this},Selection.prototype.getVolume=function(){var e=-1;return this.objects.forEach(function(r){return r.getVolume?void(e=Math.max(e,r.getVolume())):-1}),e},Selection.prototype.fade=function(e,r,n){return r=r||0,n=n||250,n/=1e3,this.objects.forEach(function(p){return p.fade?p.fade(e,r,n):void 0}),this},Selection.prototype.fadeIn=function(){return this.objects.forEach(function(e){return e.fadeIn?e.fadeIn():void 0}),this},Selection.prototype.fadeOut=function(e,r){return e&&(e/=1e3),r&&(r/=1e3),this.objects.forEach(function(n){return n.fadeOut?n.fadeOut(r,e):void 0}),this},Selection.prototype.setVariation=function(e){return this.objects.forEach(function(r){"function"==typeof r.setVariation?r.setVariation(e):r.variation=e}),this},Selection.prototype.setActiveVariations=function(e){return this.objects.forEach(function(r){return r.setActiveVariations?r.setActiveVariations(e):void 0}),this},Selection.prototype.get=function(e){var r;return this.objects.forEach(function(n){n.get&&(r=n.get(e))}),r},Selection.prototype.set=function(e,r){return this.createDefaultSectionIfNeeded(),this.objects.forEach(function(n){return n.set?n.set(e,r):void 0}),this},Selection.prototype.find=find,Selection.prototype.group=function(){var e=this;return this.objects.forEach(function(r){r.groups&&r.groups.push(e)}),this},Selection.prototype.addTrackGroup=function(e){return this.objects.forEach(function(r){r.addTrackGroup&&r.addTrackGroup(e)}),this},Selection.prototype.getPosition=function(e,r){var n;return this.objects.length||(this.objects=[defaultInstance]),this.objects.forEach(function(p){p.getPosition&&(n=p.getPosition(e,r))}),n},Selection.prototype.on=function(e,r,n){this.objects.forEach(function(p){p.eventHandler&&p.eventHandler.addEvent(e,r,n)})},Selection.prototype.update=function(e){return this.objects.forEach(function(r){r.update&&r.update(e)}),this};var Event=function(e,r){this.fn=e,this.delay=r},EventHandler=function(){};EventHandler.prototype.addEvent=function(e,r,n){"function"!=typeof r||(this[e]=this[e]||[],this[e].push(new Event(r,n)))},EventHandler.prototype.execute=function(e,r){var n=this[e];n&&n.forEach(function(p){var l=r+p.delay;setTimeout(p.fn,l)})};var defaultParams={};defaultParams.volume=1,defaultParams.tempo=120,defaultParams.audioPath="audio",defaultParams.upbeat=0,defaultParams.partLength="1/1",defaultParams.timeSign={nominator:4,denominator:4},defaultParams.fadeTime=0,defaultParams.offset=0,defaultParams.suffix="mp3",defaultParams.loopActive=1,defaultParams.activeRange={},defaultParams.activeRange.min=0,defaultParams.activeRange.max=1,defaultParams.activeRange.minVal=0,defaultParams.activeRange.maxVal=1,defaultParams.blockRetrig=0,defaultParams.repeat=1,defaultParams.quantize="1/1";var masterBus=new Bus;if(masterBus.output.channelCount=maxChannelCount,iMus.master=masterBus,iMus.audioContext=audioContext,iMus.instances=[],iMus.setOffset=function(e){for(var r,n=0;n<this.instances.length;n++){console.log("diff - "+new Date+" : "+n);var p=this.instances[n];r=p.setOffset(e)}console.log("nextTime: "+r)},iMus.set=set,iMus.play=function(e,r,n,p){var l=new Selection(e,defaultInstance);l.play(r,n,p)},iMus.stop=function(e){var r=new Selection(e,defaultInstance);r.stop()},iMus.isPlaying=function(){var e=!1;return this.instances.forEach(function(r){e=r.playing||e}),e},iMus.setInterval=function(e,r,n,p){return p=p||-1,defaultInstance.on(r,e,n,p)},iMus.setTimeout=function(e,r,n){return defaultInstance.on(r,e,n,1)},iMus.getPosition=function(e,r){return defaultInstance.getPosition(e,r)},iMus.clearTimeouts=function(){for(;defaultInstance.intervalIDs.length;){var e=defaultInstance.intervalIDs.pop();clearTimeout(e)}},iMus.getDefaultInstance=function(){return defaultInstance},iMus.fade=function(e,r,n){defaultInstance.fade(e,r,n)},iMus.fadeIn=function(e,r){defaultInstance.fadeIn(e,r)},iMus.fadeOut=function(e,r){defaultInstance.fadeOut(e,r)},iMus.createBus=function(){return defaultInstance.getBus()},audioContext.createBufferSource(),window.audioContext=audioContext,iMus.addLoopTrack=function(e){return iMus(defaultSectionName).addLoopTrack(e)},iMus.addTrackGroup=function(e){return iMus(defaultSectionName).addTrackGroup(e)},iMus.addMotif=function(e){return iMus(defaultSectionName).addMotif(e)},iMus.addLeadIn=iMus.addMotif,iMus.addStingerTrack=iMus.addMotif,window.module)module.exports=iMus;else{window.iMus=iMus,window.iMusic=iMus;var defaultInstance=new iMus;defaultInstance.addSection({tags:defaultSectionName})}setInterval(function(){},1e3)})(jQuery);